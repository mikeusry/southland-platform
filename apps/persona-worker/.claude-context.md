# Persona Worker - Claude Context

Cloudflare Worker for real-time persona scoring and journey stage detection.

## What This Does

1. Receives pixel events from point.dog
2. Computes persona probability scores (backyard, commercial, lawn, general)
3. Detects journey stage (unaware â†’ evangelist)
4. Caches results in Cloudflare KV
5. Forwards enriched events to BigQuery

## Key Files

| File | Purpose |
|------|---------|
| `src/index.ts` | Worker entry point, routing |
| `src/scoring.ts` | Persona scoring algorithm |
| `src/stages.ts` | Journey stage detection |
| `src/types.ts` | TypeScript interfaces |

## Persona Scoring

Weighted signals with recency decay:

```typescript
const SIGNAL_WEIGHTS = {
  decision_engine: 10,  // Explicit choice
  purchase: 8,
  phone_call: 7,
  add_to_cart: 6,
  search_query: 5,
  product_view: 4,
  page_view: 1
};

const RECENCY_MULTIPLIERS = {
  lastHour: 1.5,
  last24h: 1.0,
  last72h: 0.7,
  older: 0.3
};
```

## Journey Stages

10 stages from unaware to evangelist:

| Stage | Key Indicator |
|-------|---------------|
| unaware | < 2 page views |
| aware | Viewed products |
| receptive | Content engagement |
| zmot | Multiple product views |
| objections | Viewed FAQ/guarantees |
| test_prep | Added to cart |
| challenge | First purchase |
| success | Return visit post-purchase |
| commitment | 2+ purchases |
| evangelist | 3+ purchases + review |

## KV Schema

```typescript
// Key: visitor:{anonymous_id}
{
  persona: 'commercial',
  confidence: 0.72,
  stage: 'aware',
  stageConfidence: 0.65,
  signals: [...],
  lastSeen: '2024-01-15T12:00:00Z'
}
```

## Development

```bash
pnpm dev          # Local development
pnpm deploy       # Deploy to Cloudflare
```

## Environment

| Variable | Purpose |
|----------|---------|
| `VISITOR_KV` | KV namespace binding |
| `BRAND_ID` | Brand identifier |
| `BIGQUERY_WEBHOOK_URL` | BigQuery ingestion |

## Related

- `apps/astro-content/src/components/tunnels/` - Reality Tunnel components
- `apps/astro-content/src/lib/persona.ts` - Client-side utilities
- `docs/SOUTHLAND-CDP-PLAYBOOK.md` - Full strategy
