# Southland Content - Claude Context

Astro content layer for Southland Organics' "fake headless" hybrid architecture.

## Quick Reference

| Item | Value |
|------|-------|
| **Purpose** | Podcast hub + future content pages for southlandorganics.com |
| **Stack** | Astro 5, MDX, Tailwind CSS 3, TypeScript |
| **Deploy** | Cloudflare Pages (static + middleware) |
| **Domain** | southlandorganics.com/podcast/* |
| **Status** | Phase 1 - Podcast deployment |

## Current Phase: Podcast Launch

**Routing Strategy:**
- `/podcast/*` → Served by Cloudflare Pages (Astro static files)
- `/*` (everything else) → Proxied to Shopify via Cloudflare middleware

**Header/Footer (Phase 1):**
- TWO codebases: React (`packages/ui-react`) + Shopify Liquid theme
- Navigation synced from Shopify API at build time (`src/data/layout.json`)
- Styling manually kept in sync via `shopify-tokens.css`

**Header/Footer (Future Full Headless):**
- ONE codebase: Astro components only
- Shopify becomes API-only

## Architecture

```
southlandorganics.com
        │
        ▼
  Cloudflare Pages Middleware
  (functions/_middleware.ts)
        │
        ├── /podcast/*  ──────▶  Astro Static Files (this build)
        ├── /admin/*    ──────▶  Astro Static Files
        ├── /_astro/*   ──────▶  Astro Static Files
        │
        └── /* (everything else) ──▶  Shopify (proxied)
```

## Deployment Config

**Decision (Feb 2025):** Cloudflare Pages, NOT Vercel
- Reason: Need Workers/middleware for hybrid routing (Astro + Shopify proxy)
- Cloudflare handles both static hosting AND request interception
- Vercel would require separate edge functions setup

**Files:**
- `wrangler.toml` - Cloudflare Pages config
- `functions/_middleware.ts` - Route proxy logic
- `public/_routes.json` - Static route optimization

**Environment Variables:**
```
PUBLIC_SITE_URL=https://southlandorganics.com
SHOPIFY_ORIGIN=https://southland-organics.myshopify.com
```

**Deploy Command:**
```bash
pnpm build --filter=@southland/astro-content
# Then: Cloudflare Pages dashboard or wrangler pages deploy dist
```

## Key Files

| File | Purpose |
|------|---------|
| `src/pages/podcast/index.astro` | Podcast hub page |
| `src/pages/podcast/[...slug].astro` | Episode detail pages |
| `src/pages/podcast/topics/[slug].astro` | Topic pages with SEO schema |
| `src/pages/podcast/feed.xml.ts` | RSS feed with iTunes extensions |
| `src/components/shared/Header.astro` | Navigation (matches Shopify) |
| `src/components/shared/Footer.astro` | Footer (matches Shopify) |
| `src/content/episodes/*.mdx` | Episode content files |
| `src/content/topics/*.mdx` | Topic pages with SEO fields |
| `src/content/products/*.mdx` | Product references for related links |
| `src/content/config.ts` | Content collection schemas |
| `src/styles/shopify-tokens.css` | Design tokens from Shopify API |
| `scripts/sync-shopify-theme.js` | Fetches CSS/tokens from Shopify |
| `.shopify-theme-settings.json` | Cached theme settings reference |

## Commands

```bash
npm run dev                       # Dev server (port 4321)
npm run build && npx serve dist   # Build and preview
npm run astro check               # Type checking

# Shopify theme sync (uses Mothership/.env credentials)
node scripts/sync-shopify-theme.js   # Full CSS + tokens sync
node scripts/get-theme-settings.js   # Extract settings_data.json
```

## Shopify Theme Sync (Decision: Jan 2025)

**Approach:** Use Shopify Admin API to fetch theme settings, NOT web scraping.

- Credentials stored in `~/CODING/mothership/.env` (SHOPIFY_ACCESS_TOKEN)
- Scripts fetch from Booster 6.1.0 theme's `settings_data.json`
- Tokens extracted and written to `src/styles/shopify-tokens.css`
- Cached settings in `.shopify-theme-settings.json` for reference

**Why Admin API?** Full access to exact theme values, embedded in repo, no external dependencies.

## Brand Colors (Synced from Shopify - Jan 2025)

```css
--color-accent: #44883e      /* Primary green, links */
--color-title: #2c5234       /* Dark green, headings, hover */
--color-text: #191d21        /* Body text */
--color-secondary-text: #686363  /* Secondary/muted text */
```

## Fonts

- **Headings:** Eveleth Dot (self-hosted at `/fonts/eveleth-dot-regular.ttf`)
- **Body:** Open Sans (Google Fonts)

## Images (Cloudinary)

**Cloud Name:** `southland-organics`

**Why Cloudinary instead of Astro Image?** We use Cloudinary to avoid conflicts with Astro's built-in Image component and to leverage Cloudinary's advanced transformations, CDN, and format optimization (WebP, AVIF).

### Folder Structure

```
Southland Website/
├── Southland Branding/      # Logos, brand assets, icons
│   ├── logos/               # Logo variations (primary, white, black)
│   ├── icons/               # UI icons, favicons
│   └── patterns/            # Brand patterns, textures
├── podcast/                 # Ag & Culture Podcast assets
│   ├── episodes/            # Episode thumbnails
│   ├── guests/              # Guest headshots
│   └── covers/              # Podcast cover art
├── products/                # Product images
├── team/                    # Team member photos
├── blog/                    # Blog post images
└── heroes/                  # Hero/banner images
```

### Components

| Component | Purpose |
|-----------|---------|
| `CloudinaryImage.astro` | General purpose image with responsive srcset, lazy loading, blur-up placeholder |
| `CloudinaryHero.astro` | Full-width hero/banner images |
| `CloudinaryAvatar.astro` | Circular face-focused avatars |
| `CloudinaryGallery.astro` | Image gallery with lightbox |

### Usage Examples

```astro
import CloudinaryImage from '../components/CloudinaryImage.astro';
import { buildSouthlandUrl, buildBrandingUrl } from '../lib/cloudinary';

<!-- Basic image -->
<CloudinaryImage
  publicId="Southland Website/podcast/episodes/ep-01"
  alt="Episode thumbnail"
  width={800}
  height={450}
/>

<!-- With effects -->
<CloudinaryImage
  publicId="Southland Website/heroes/field"
  alt="Hero image"
  width={1600}
  effect="brightness:70"
  placeholder="blur"
/>

<!-- Direct URL (for CSS backgrounds, etc.) -->
const logoUrl = buildBrandingUrl('logos/southland-logo-primary', { width: 200 });
```

### Utility Functions

```typescript
import {
  buildCloudinaryUrl,     // Raw URL builder
  buildSouthlandUrl,       // Prefixes "Southland Website/"
  buildBrandingUrl,        // Prefixes "Southland Website/Southland Branding/"
  getLogoUrl,              // Logo variants (primary, white, black, icon)
  getCloudinaryResponsiveSet,  // Generates srcset
  getEpisodeThumbnail,     // Episode-specific helper
  getGuestImage,           // Guest headshot helper
} from '../lib/cloudinary';
```

### Environment Variable

```bash
PUBLIC_CLOUDINARY_CLOUD_NAME=southland-organics
```

## Content Schema (Episodes)

```yaml
title: "Episode Title"
episodeNumber: 1
publishDate: 2026-01-05
description: "Short description"
muxPlaybackId: "abc123xyz" # Mux video playback ID
audioUrl: "https://..."    # For RSS
duration: "45:32"
chapters: [...]            # Time-stamped chapters
guests: [...]              # Guest info
topics: [...]              # Topic tags
transcript: [...]          # Timestamped transcript
```

## Routes

| Route | Description |
|-------|-------------|
| `/podcast/` | Hub with episode grid |
| `/podcast/[slug]/` | Episode page |
| `/podcast/search/` | Transcript search |
| `/podcast/guests/` | Guest directory |
| `/podcast/topics/` | Topic browser |
| `/podcast/feed.xml` | RSS 2.0 feed |
| `/build-a-case/` | Mix & Match gallon case builder (React island) |

## Mix & Match Gallon Case

**Route:** `/build-a-case/` — React island bundle picker using Shopify Storefront API.

**How it works:** Customer picks any 4 gallon products, adds as a bundle to Storefront API cart with `_bundle_id` attributes, proceeds to Shopify checkout where an Automatic Discount applies.

**Key architectural note:** Gallon products are **variants** (Size = "1 Gallon") of multi-variant products, not standalone products. `getGallonProducts()` queries all products and filters for variants with `selectedOptions: [{name: "Size", value: "1 Gallon"}]`. No collection needed.

**Key files:**

| File | Purpose |
|------|---------|
| `src/components/bundle/CaseBuilder.tsx` | Main React island (uses `getGallonVariant()` to find 1-Gallon variant) |
| `src/components/bundle/ProductSelector.tsx` | Product card with +/- controls (receives specific variant prop) |
| `src/components/bundle/CaseProgress.tsx` | Visual 4-slot progress |
| `src/components/bundle/SavingsDisplay.tsx` | Savings calculator |
| `src/lib/cart.ts` | Cart state management (localStorage + cookie) |
| `src/pages/build-a-case/index.astro` | Page shell |

**Dependencies:**
- `@southland/shopify-storefront` package (cart mutations, product queries)
- `DISCOUNT_PERCENT` in CaseBuilder.tsx must match Shopify Admin automatic discount
- Client-side code must pass `import.meta.env.PUBLIC_*` to `createClient()` (not `process.env`)

**Shopify Admin prerequisites (Phase A — ops does this):**
1. Create Automatic Discount: buy 4+ gallon variants, percentage off

## Current Status

**Episode 1 LIVE:** "The Invisible Economy Under Your Feet" (soil biology intro)

## TODO (Priority)

### Phase 1: Podcast Launch (Current)

- [x] Add real episode content (Ep 1 complete)
- [x] Connect Klaviyo email capture (podcast subscriber properties live)
- [x] SEO optimization + topic schema markup (Jan 2025)
- [x] Shopify theme token sync (Jan 2025)
- [x] WOFF2 font conversion (62% smaller)
- [x] Header/Footer React components matching Shopify
- [x] Cloudflare Pages middleware for hybrid routing
- [ ] Deploy to Cloudflare Pages production
- [ ] DNS routing (southlandorganics.com/podcast/* → CF Pages)
- [ ] Add point.dog tracking pixel
- [ ] Add Episode 2 when ready

### Phase 2: Blog Migration

- [x] Set up TinaCMS (migrated from Keystatic, Feb 2026)
- [x] Migrate 287 blog posts from Shopify to MDX (Jan 30, 2026)
- [ ] Update routing middleware for /blog/*

### Phase 3: Collections

- [ ] Collection page templates (TinaCMS SEO + Shopify products)
- [ ] Update routing for /collections/*

### Phase 4: Products

- [ ] Product page templates via Storefront API
- [ ] Cart/checkout client-side integration

### Phase 5: Full Migration

- [ ] Homepage in Astro
- [ ] Remove Shopify theme dependency
- [ ] Header/Footer becomes ONE codebase

## CDP / Reality Tunnels (Feb 2025)

**Purpose:** Personalize the site based on visitor persona (Backyard Betty, Broiler Bill, Turf Taylor).

### Personas

| ID | Label | LTV | Focus |
|----|-------|-----|-------|
| `backyard` | Backyard Flock | $77 | Hobby chicken keepers |
| `commercial` | Commercial Poultry | $903 | Broiler farms, contract growers |
| `lawn` | Lawn & Garden | — | Turf professionals, homeowners |
| `general` | All Products | — | Skipped personalization |

### CDP Components

| Component | File | Purpose |
|-----------|------|---------|
| **DecisionEngine** | `components/cdp/DecisionEngine.astro` | Homepage 3-way persona selector |
| **PersonaContent** | `components/cdp/PersonaContent.astro` | Show/hide content by persona |
| **PersonaCTA** | `components/cdp/PersonaCTA.astro` | CTA button that changes by persona |
| **PersonaBanner** | `components/cdp/PersonaBanner.astro` | Bottom bar showing current persona |
| **OutcomeSurvey** | `components/cdp/OutcomeSurvey.astro` | Post-purchase survey form |

### Persona Utilities

```typescript
import { getPersonaId, setPersona, getPersonaConfig } from '../lib/persona';

// Get current persona
const persona = getPersonaId(); // 'backyard' | 'commercial' | 'lawn' | 'general' | null

// Set persona (also fires analytics event)
setPersona('commercial', 'decision_engine');

// Get config (label, color, CTA text/href)
const config = getPersonaConfig('backyard');
```

### Usage Examples

```astro
<!-- Show content only for commercial users -->
<PersonaContent show="commercial">
  <p>Improve your FCR with...</p>
</PersonaContent>

<!-- Show content for unknown visitors -->
<PersonaContent showIfUnknown>
  <p>Tell us about yourself...</p>
</PersonaContent>

<!-- CTA that auto-changes by persona -->
<PersonaCTA variant="primary" />
```

### Storage

- **localStorage:** `southland_persona` (JSON with id, selectedAt, source)
- **Cookie:** `sl_persona` (persona ID only, for server/cross-subdomain)
- **URL param:** `?persona=commercial` (sets persona from tracking links)

### Admin Tools

| Page | URL | Purpose |
|------|-----|---------|
| CDP Guide | `/admin/cdp-guide` | Human documentation for team |
| Sales Log | `/admin/sales-log` | Log phone call outcomes |
| Betty Survey | `/survey/backyard` | Post-purchase survey |
| Bill Survey | `/survey/commercial` | Post-purchase survey |

### API Endpoints

| Endpoint | Purpose |
|----------|---------|
| `POST /api/survey/submit` | Survey submission → BigQuery |
| `POST /api/sales-log/submit` | Sales outcome log → BigQuery |

### Related Docs

- **CDP Playbook:** `docs/SOUTHLAND-CDP-PLAYBOOK.md` (full strategy)
- **BigQuery Schema:** `docs/schemas/bigquery-outcomes.sql`

## Deep Dive Docs

- [Architecture](docs/context/architecture.md) - Tech stack, file structure, patterns
- [Integrations](docs/context/integrations.md) - Cloudflare, Klaviyo, point.dog
- [Episode Workflow](docs/context/episode-workflow.md) - Release process, template, roadmap

## Related

- **Plan:** `~/.claude/plans/twinkly-launching-petal.md`
- **Hybrid spec:** `~/CODING/mothership/docs/future/southland-organics-hybrid-architecture-spec.md`
- **Mothership:** `~/CODING/mothership/` (orchestration, CDP)
- **Shopify theme:** Separate repo (unchanged by this project)
