---
/**
 * Episode Page - /podcast/[slug]/
 * Individual episode with video/audio, transcript, chapters, and sharing
 */

import PodcastLayout from '../../layouts/PodcastLayout.astro'
import VideoEmbed from '../../components/podcast/VideoEmbed.astro'
import AudioPlayer from '../../components/podcast/AudioPlayer.astro'
import ChapterMarkers from '../../components/podcast/ChapterMarkers.astro'
import InteractiveTranscript from '../../components/podcast/InteractiveTranscript.astro'
import ShareClipTool from '../../components/podcast/ShareClipTool.astro'
import SubscribeButtons from '../../components/podcast/SubscribeButtons.astro'
import GuestCard from '../../components/podcast/GuestCard.astro'
import AuthorCard from '../../components/blog/AuthorCard.astro'
import RelatedEpisodes from '../../components/podcast/RelatedEpisodes.astro'
import EpisodeNav from '../../components/podcast/EpisodeNav.astro'
import EmailCapture from '../../components/shared/EmailCapture.astro'
import ProductCard from '../../components/shared/ProductCard.astro'
import TopicTag from '../../components/shared/TopicTag.astro'
import { getCollection, getEntry, render } from 'astro:content'
import { buildPersonSchema } from '../../lib/schema'

const { slug: episodeSlug } = Astro.params

// Get all published episodes (reused for current episode lookup + navigation)
const allEpisodes = await getCollection('episodes', ({ data }) => {
  return data.draft !== true
})

const episode = allEpisodes.find(
  (e) => e.id === episodeSlug || e.id.replace(/\.mdx?$/, '') === episodeSlug
)
if (!episode) {
  return Astro.redirect('/podcast/')
}
const { Content } = await render(episode)

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://southlandorganics.com'

// Resolve guest slugs to team member entries for E-E-A-T
const resolvedGuests = await Promise.all(
  (episode.data.guests || []).map(async (guest) => {
    let teamMember = null
    if (guest.slug) {
      try {
        teamMember = await getEntry('team', guest.slug)
      } catch {
        // Guest not in team collection — use inline data
      }
    }
    return { ...guest, teamMember }
  })
)

// Hosts are guests with team profiles (for AuthorCard display)
const hosts = resolvedGuests.filter((g) => g.teamMember)

// Resolve related blog posts (cross-promotion)
const relatedBlogPosts = episode.data.relatedBlogPosts?.length
  ? await Promise.all(
      episode.data.relatedBlogPosts.map(async (ref) => {
        try {
          return await getEntry('blog', ref.slug)
        } catch {
          return null
        }
      })
    ).then((posts) => posts.filter(Boolean))
  : []

// Format date
const formattedDate = new Intl.DateTimeFormat('en-US', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format(episode.data.publishDate)

// Convert duration to ISO 8601 format for schema
function durationToISO(durationStr: string): string {
  const parts = durationStr.split(':').map(Number)
  if (parts.length === 2) {
    return `PT${parts[0]}M${parts[1]}S`
  } else if (parts.length === 3) {
    return `PT${parts[0]}H${parts[1]}M${parts[2]}S`
  }
  return 'PT0S'
}

// Schema markup for PodcastEpisode
const episodeSchema = {
  '@context': 'https://schema.org',
  '@type': 'PodcastEpisode',
  name: episode.data.title,
  description: episode.data.description,
  url: `${siteUrl}/podcast/${episodeSlug}/`,
  datePublished: episode.data.publishDate.toISOString(),
  episodeNumber: episode.data.episodeNumber,
  duration: durationToISO(episode.data.duration),
  image: episode.data.thumbnail
    ? `${siteUrl}${episode.data.thumbnail}`
    : `${siteUrl}/images/podcast/og-default.jpg`,
  partOfSeries: {
    '@type': 'PodcastSeries',
    name: 'Ag & Culture Podcast',
    url: `${siteUrl}/podcast/`,
  },
  ...(episode.data.audioUrl && {
    associatedMedia: {
      '@type': 'AudioObject',
      contentUrl: episode.data.audioUrl,
    },
  }),
  ...(resolvedGuests.length > 0 && {
      actor: resolvedGuests.map((g) =>
        g.teamMember
          ? buildPersonSchema(g.teamMember)
          : { '@type': 'Person', name: g.name }
      ),
    }),
}

// Determine if we have video or audio
const hasVideo = episode.data.muxPlaybackId || episode.data.youtubeUrl
const hasAudio = episode.data.audioUrl
---

<PodcastLayout
  title={episode.data.title}
  description={episode.data.description}
  ogImage={episode.data.thumbnail || '/images/podcast/og-default.jpg'}
  schema={episodeSchema}
  breadcrumbs={[
    { label: `Episode ${episode.data.episodeNumber}`, href: `/podcast/${episodeSlug}/` },
  ]}
>
  <article class="py-8 md:py-12">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      {/* Episode Header */}
      <header class="mb-8">
        <div class="mb-2 flex items-center gap-2 text-sm text-gray-500">
          <span class="font-medium text-southland-green">Episode {episode.data.episodeNumber}</span>
          <span>•</span>
          <time datetime={episode.data.publishDate.toISOString()}>{formattedDate}</time>
          <span>•</span>
          <span>{episode.data.duration}</span>
        </div>
        <h1 class="mb-4 text-3xl font-bold text-gray-900 md:text-4xl">
          {episode.data.title}
        </h1>
        <p class="mb-6 text-lg text-gray-600">
          {episode.data.description}
        </p>

        {/* Topics */}
        {
          episode.data.topics && episode.data.topics.length > 0 && (
            <div class="mb-6 flex flex-wrap gap-2">
              {episode.data.topics.map((topic) => (
                <TopicTag topic={topic} />
              ))}
            </div>
          )
        }

        {/* Subscribe Buttons */}
        <SubscribeButtons
          youtubeUrl={episode.data.youtubeUrl}
          applePodcastUrl={episode.data.applePodcastUrl}
          spotifyUrl={episode.data.spotifyUrl}
          variant="compact"
          utmContext={`episode-${episodeSlug}`}
        />
      </header>

      {/* Main Content Grid */}
      <div class="grid gap-8 lg:grid-cols-3">
        {/* Main Column */}
        <div class="space-y-8 lg:col-span-2">
          {/* Video Player */}
          {
            hasVideo && (
              <VideoEmbed
                muxPlaybackId={episode.data.muxPlaybackId}
                youtubeUrl={episode.data.youtubeUrl}
                title={episode.data.title}
                episodeNumber={episode.data.episodeNumber}
                episodeSlug={episodeSlug}
                poster={episode.data.thumbnail}
              />
            )
          }

          {/* Audio Player (if no video or as alternative) */}
          {
            hasAudio && (
              <AudioPlayer
                audioUrl={episode.data.audioUrl!}
                title={episode.data.title}
                episodeNumber={episode.data.episodeNumber}
                episodeSlug={episodeSlug}
                duration={episode.data.duration}
                durationSeconds={episode.data.durationSeconds}
                chapters={episode.data.chapters}
                thumbnail={episode.data.thumbnail}
              />
            )
          }

          {/* Hosts (E-E-A-T AuthorCards) */}
          {
            hosts.length > 0 && (
              <div class="space-y-3">
                {hosts.map((host) => (
                  <AuthorCard
                    name={host.teamMember!.data.name}
                    slug={host.teamMember!.id.replace(/\.mdx?$/, '')}
                    role={host.teamMember!.data.role}
                    bio={host.teamMember!.data.bio}
                    photo={host.teamMember!.data.photo}
                    credentials={host.teamMember!.data.credentials}
                    yearsExperience={host.teamMember!.data.yearsExperience}
                    links={host.teamMember!.data.links}
                    variant="compact"
                    label="Host"
                  />
                ))}
              </div>
            )
          }

          {/* Chapter Markers */}
          {
            episode.data.chapters && episode.data.chapters.length > 0 && (
              <div class="rounded-xl border border-gray-100 bg-white p-6">
                <ChapterMarkers
                  chapters={episode.data.chapters}
                  episodeSlug={episodeSlug}
                  episodeNumber={episode.data.episodeNumber}
                />
              </div>
            )
          }

          {/* Show Notes / Content */}
          <div class="rounded-xl border border-gray-100 bg-white p-6">
            <h2 class="mb-4 text-xl font-semibold text-gray-900">Show Notes</h2>
            <div class="prose prose-southland max-w-none">
              <Content />
            </div>
          </div>

          {/* Interactive Transcript */}
          {
            episode.data.transcript && episode.data.transcript.length > 0 && (
              <div class="rounded-xl border border-gray-100 bg-white p-6">
                <InteractiveTranscript
                  transcript={episode.data.transcript}
                  episodeSlug={episodeSlug}
                  episodeNumber={episode.data.episodeNumber}
                  maxHeight="600px"
                />
              </div>
            )
          }

          {/* Related Blog Posts (Cross-Promotion) */}
          {
            relatedBlogPosts.length > 0 && (
              <div class="rounded-xl border border-gray-100 bg-white p-6">
                <h2 class="mb-4 text-xl font-semibold text-gray-900">Related Articles</h2>
                <div class="space-y-3">
                  {relatedBlogPosts.map((post) => post && (
                    <a
                      href={`/blog/${post.id.replace(/\.mdx?$/, '')}/`}
                      class="block rounded-lg border border-gray-100 p-4 transition-shadow hover:shadow-md"
                    >
                      <h3 class="font-medium text-shopify-title">{post.data.title}</h3>
                      <p class="mt-1 line-clamp-2 text-sm text-shopify-secondary-text">
                        {post.data.description}
                      </p>
                    </a>
                  ))}
                </div>
              </div>
            )
          }

          {/* Episode Navigation */}
          <div class="rounded-xl border border-gray-100 bg-white">
            <EpisodeNav currentEpisode={episode} allEpisodes={allEpisodes} />
          </div>
        </div>

        {/* Sidebar */}
        <aside class="space-y-6">
          {/* Guests */}
          {
            episode.data.guests && episode.data.guests.length > 0 && (
              <div class="rounded-xl border border-gray-100 bg-white p-6">
                <h3 class="mb-4 font-semibold text-gray-900">
                  {episode.data.guests.length === 1 ? 'Guest' : 'Guests'}
                </h3>
                <div class="space-y-4">
                  {episode.data.guests.map((guest) => (
                    <GuestCard
                      name={guest.name}
                      slug={guest.slug}
                      role={guest.role}
                      bio={guest.bio}
                      photo={guest.photo}
                      links={guest.links}
                      variant="sidebar"
                    />
                  ))}
                </div>
              </div>
            )
          }

          {/* Share Clip Tool */}
          <ShareClipTool
            episodeSlug={episodeSlug}
            episodeNumber={episode.data.episodeNumber}
            episodeTitle={episode.data.title}
            durationSeconds={episode.data.durationSeconds}
          />

          {/* Email Capture */}
          <EmailCapture
            headline="Never miss an episode"
            description="Subscribe to get notified when new episodes drop."
            variant="card"
            source="episode_page"
            episodeSlug={episodeSlug}
          />

          {/* Related Episodes */}
          <RelatedEpisodes currentSlug={episodeSlug} episodes={allEpisodes} maxItems={3} />

          {/* Related Products */}
          {
            episode.data.relatedProducts && episode.data.relatedProducts.length > 0 && (
              <div class="rounded-xl border border-gray-100 bg-white p-6">
                <h3 class="mb-4 font-semibold text-gray-900">Related Products</h3>
                <div class="space-y-4">
                  {episode.data.relatedProducts.map((product) => (
                    <ProductCard name={product.name} slug={product.slug} cta={product.cta} />
                  ))}
                </div>
              </div>
            )
          }
        </aside>
      </div>
    </div>
  </article>
</PodcastLayout>

<style>
  .prose-southland {
    --tw-prose-links: #1a5f3c;
    --tw-prose-headings: #1a5f3c;
  }
</style>
