---
/**
 * Homepage - Decision Engine + Reality Tunnels
 *
 * CDP Week 1-8: 3-way branch to route visitors into persona-specific reality tunnels
 *
 * Visitor Flow:
 * 1. New visitor arrives ‚Üí Decision Engine asks "What best describes you?"
 * 2. Selection stored in localStorage + cookie + event fired
 * 3. Returning visitors with known persona ‚Üí Personalized Reality Tunnel
 *
 * Reality Tunnels:
 * - Betty (backyard): BettyHero, BettyProducts, BettyTestimonials
 * - Bill (commercial): BillHero, BillProducts, BillTestimonials
 * - Taylor (lawn): TaylorHero, TaylorProducts, TaylorTestimonials
 *
 * A/B Testing:
 * - Tunnel variant: Full personalized experience
 * - Generic variant: Control group (Decision Engine)
 */
import BaseLayout from '../layouts/BaseLayout.astro'
import DecisionEngine from '../components/cdp/DecisionEngine.astro'
import RealityTunnel from '../components/tunnels/RealityTunnel.astro'
import BettyHero from '../components/tunnels/betty/BettyHero.astro'
import BettyProducts from '../components/tunnels/betty/BettyProducts.astro'
import BettyTestimonials from '../components/tunnels/betty/BettyTestimonials.astro'
import BillHero from '../components/tunnels/bill/BillHero.astro'
import BillProducts from '../components/tunnels/bill/BillProducts.astro'
import BillTestimonials from '../components/tunnels/bill/BillTestimonials.astro'
import TaylorHero from '../components/tunnels/taylor/TaylorHero.astro'
import TaylorProducts from '../components/tunnels/taylor/TaylorProducts.astro'
import TaylorTestimonials from '../components/tunnels/taylor/TaylorTestimonials.astro'
import ABTest from '../components/cdp/ABTest.astro'

const title = 'Southland Organics | Organic Solutions for Poultry & Lawn'
const description =
  'Organic probiotics and natural solutions for backyard flocks, commercial poultry operations, and lawn care. OMRI Listed, family-owned, made in Georgia.'

// Try to read persona from cookie for SSR
let serverPersona: string | null = null
let serverStage: string = 'aware'

const personaCookie = Astro.cookies.get('sl_persona')
if (personaCookie) {
  serverPersona = personaCookie.value
}

const stageCookie = Astro.cookies.get('sl_stage')
if (stageCookie) {
  serverStage = stageCookie.value
}

// Schema for homepage
const schema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'Southland Organics',
  description: description,
  url: 'https://southlandorganics.com',
  logo: 'https://res.cloudinary.com/southland-organics/image/upload/v1/Southland%20Website/Southland%20Branding/logos/southland-logo-primary.png',
  contactPoint: {
    '@type': 'ContactPoint',
    telephone: '+1-800-608-3755',
    contactType: 'customer service',
    areaServed: 'US',
    availableLanguage: 'English',
  },
  sameAs: [
    'https://www.facebook.com/southlandorganics',
    'https://www.instagram.com/southlandorganics',
    'https://www.youtube.com/southlandorganics',
  ],
}
---

<BaseLayout title={title} description={description} schema={schema}>
  <!-- Reality Tunnel Container - Shows personalized content based on persona -->
  <RealityTunnel enableABTest={true}>
    <!-- Betty (Backyard) Tunnel -->
    <Fragment slot="backyard">
      <BettyHero stage={serverStage as any} />
      <BettyProducts />
      <BettyTestimonials limit={3} />

      <!-- Trust Section (Betty-styled) -->
      <section class="betty-trust">
        <div class="betty-trust__container">
          <div class="betty-trust__grid">
            <div class="betty-trust__item">
              <div class="betty-trust__icon">üêî</div>
              <div class="betty-trust__text">
                <span class="betty-trust__value">10,000+</span>
                <span class="betty-trust__label">Happy Flocks</span>
              </div>
            </div>
            <div class="betty-trust__item">
              <div class="betty-trust__icon">‚≠ê</div>
              <div class="betty-trust__text">
                <span class="betty-trust__value">4.8/5</span>
                <span class="betty-trust__label">Star Rating</span>
              </div>
            </div>
            <div class="betty-trust__item">
              <div class="betty-trust__icon">üåø</div>
              <div class="betty-trust__text">
                <span class="betty-trust__value">OMRI</span>
                <span class="betty-trust__label">Listed Organic</span>
              </div>
            </div>
            <div class="betty-trust__item">
              <div class="betty-trust__icon">üá∫üá∏</div>
              <div class="betty-trust__text">
                <span class="betty-trust__value">USA</span>
                <span class="betty-trust__label">Made in Georgia</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CTA Banner -->
      <section class="betty-cta-banner">
        <div class="betty-cta-banner__container">
          <h2 class="betty-cta-banner__heading">Ready to Give Your Flock the Best?</h2>
          <p class="betty-cta-banner__text">
            Join thousands of backyard chicken keepers who trust Southland Organics.
          </p>
          <div class="betty-cta-banner__buttons">
            <a
              href="/shop/poultry/backyard/"
              class="betty-cta-banner__btn betty-cta-banner__btn--primary"
            >
              Shop Backyard Products
            </a>
            <a
              href="/quiz/backyard/"
              class="betty-cta-banner__btn betty-cta-banner__btn--secondary"
            >
              Take the Flock Quiz
            </a>
          </div>
        </div>
      </section>
    </Fragment>

    <!-- Bill (Commercial) Tunnel -->
    <Fragment slot="commercial">
      <BillHero stage={serverStage as any} />
      <BillProducts />
      <BillTestimonials limit={3} />

      <!-- Trust Section (Bill-styled) -->
      <section class="bill-trust">
        <div class="bill-trust__container">
          <div class="bill-trust__grid">
            <div class="bill-trust__item">
              <div class="bill-trust__value">500+</div>
              <div class="bill-trust__label">Growers Nationwide</div>
            </div>
            <div class="bill-trust__item">
              <div class="bill-trust__value">1-2%</div>
              <div class="bill-trust__label">Mortality Reduction</div>
            </div>
            <div class="bill-trust__item">
              <div class="bill-trust__value">OMRI</div>
              <div class="bill-trust__label">Listed Organic</div>
            </div>
            <div class="bill-trust__item">
              <div class="bill-trust__value">24/7</div>
              <div class="bill-trust__label">Technical Support</div>
            </div>
          </div>
        </div>
      </section>

      <!-- CTA Banner -->
      <section class="bill-cta-banner">
        <div class="bill-cta-banner__container">
          <h2 class="bill-cta-banner__heading">Ready to Improve Your Flock Performance?</h2>
          <p class="bill-cta-banner__text">
            Join 500+ commercial growers seeing measurable ROI with Southland Organics.
          </p>
          <div class="bill-cta-banner__buttons">
            <a href="/contact/quote/" class="bill-cta-banner__btn bill-cta-banner__btn--primary">
              Request a Quote
            </a>
            <a href="/trial/" class="bill-cta-banner__btn bill-cta-banner__btn--secondary">
              Start a Trial
            </a>
          </div>
        </div>
      </section>
    </Fragment>

    <!-- Taylor (Lawn) Tunnel -->
    <Fragment slot="lawn">
      <TaylorHero stage={serverStage as any} />
      <TaylorProducts />
      <TaylorTestimonials limit={3} />

      <!-- Trust Section (Taylor-styled) -->
      <section class="taylor-trust">
        <div class="taylor-trust__container">
          <div class="taylor-trust__grid">
            <div class="taylor-trust__item">
              <div class="taylor-trust__value">1,000+</div>
              <div class="taylor-trust__label">Lawn Pros</div>
            </div>
            <div class="taylor-trust__item">
              <div class="taylor-trust__value">50</div>
              <div class="taylor-trust__label">States Served</div>
            </div>
            <div class="taylor-trust__item">
              <div class="taylor-trust__value">OMRI</div>
              <div class="taylor-trust__label">Listed Organic</div>
            </div>
            <div class="taylor-trust__item">
              <div class="taylor-trust__value">15+</div>
              <div class="taylor-trust__label">Years Experience</div>
            </div>
          </div>
        </div>
      </section>

      <!-- CTA Banner -->
      <section class="taylor-cta-banner">
        <div class="taylor-cta-banner__container">
          <h2 class="taylor-cta-banner__heading">Ready to Go Organic?</h2>
          <p class="taylor-cta-banner__text">
            Join thousands of lawn care professionals getting better results with healthier soil.
          </p>
          <div class="taylor-cta-banner__buttons">
            <a href="/shop/lawn/" class="taylor-cta-banner__btn taylor-cta-banner__btn--primary">
              Shop Lawn Products
            </a>
            <a
              href="/contact/sample/"
              class="taylor-cta-banner__btn taylor-cta-banner__btn--secondary"
            >
              Request Free Samples
            </a>
          </div>
        </div>
      </section>
    </Fragment>

    <!-- Default: Decision Engine for new/unknown visitors -->
    <Fragment slot="default">
      <!-- Hero Section with Decision Engine -->
      <section class="flex min-h-[80vh] items-center bg-gradient-to-b from-white to-gray-50">
        <div class="w-full">
          <!-- Logo & Tagline -->
          <div class="py-8 text-center md:py-12">
            <img
              src="https://res.cloudinary.com/southland-organics/image/upload/c_scale,w_300/v1/Southland%20Website/Southland%20Branding/logos/southland-logo-primary.png"
              alt="Southland Organics"
              class="mx-auto mb-4 h-20 md:h-24"
              width="300"
              height="96"
            />
            <p class="mx-auto max-w-2xl px-4 text-lg text-gray-600 md:text-xl">
              Organic solutions for healthier birds, better soil, and a cleaner planet.
            </p>
          </div>

          <!-- Decision Engine -->
          <DecisionEngine />
        </div>
      </section>

      <!-- Trust Badges -->
      <section class="border-t border-gray-100 bg-white py-12">
        <div class="mx-auto max-w-4xl px-4">
          <div class="grid grid-cols-2 gap-8 text-center md:grid-cols-4">
            <div>
              <div class="mb-1 text-3xl font-bold text-green-700">15+</div>
              <div class="text-sm text-gray-600">Years in Business</div>
            </div>
            <div>
              <div class="mb-1 text-3xl font-bold text-green-700">OMRI</div>
              <div class="text-sm text-gray-600">Listed Organic</div>
            </div>
            <div>
              <div class="mb-1 text-3xl font-bold text-green-700">USA</div>
              <div class="text-sm text-gray-600">Made in Georgia</div>
            </div>
            <div>
              <div class="mb-1 text-3xl font-bold text-green-700">100%</div>
              <div class="text-sm text-gray-600">Natural Ingredients</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Quick Links for Returning Visitors -->
      <section class="bg-gray-50 py-12">
        <div class="mx-auto max-w-6xl px-4">
          <h2 class="mb-8 text-center text-2xl font-bold" style="color: var(--color-title);">
            Quick Links
          </h2>
          <div class="grid gap-4 md:grid-cols-4">
            <a
              href="/shop/"
              class="block rounded-lg bg-white p-4 text-center shadow-sm transition-shadow hover:shadow-md"
            >
              <span class="text-lg font-semibold text-gray-800">Shop All Products</span>
            </a>
            <a
              href="/podcast/"
              class="block rounded-lg bg-white p-4 text-center shadow-sm transition-shadow hover:shadow-md"
            >
              <span class="text-lg font-semibold text-gray-800">Ag & Culture Podcast</span>
            </a>
            <a
              href="/about/"
              class="block rounded-lg bg-white p-4 text-center shadow-sm transition-shadow hover:shadow-md"
            >
              <span class="text-lg font-semibold text-gray-800">About Us</span>
            </a>
            <a
              href="/contact/"
              class="block rounded-lg bg-white p-4 text-center shadow-sm transition-shadow hover:shadow-md"
            >
              <span class="text-lg font-semibold text-gray-800">Contact</span>
            </a>
          </div>
        </div>
      </section>
    </Fragment>
  </RealityTunnel>
</BaseLayout>

<style>
  /* Betty Trust Section */
  .betty-trust {
    background: white;
    padding: 48px 20px;
    border-top: 1px solid #e5e7eb;
  }

  .betty-trust__container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .betty-trust__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
  }

  @media (min-width: 768px) {
    .betty-trust__grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .betty-trust__item {
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: center;
  }

  .betty-trust__icon {
    font-size: 32px;
  }

  .betty-trust__text {
    display: flex;
    flex-direction: column;
  }

  .betty-trust__value {
    font-size: 20px;
    font-weight: 700;
    color: var(--color-title, #2c5234);
  }

  .betty-trust__label {
    font-size: 13px;
    color: #6b7280;
  }

  /* Betty CTA Banner */
  .betty-cta-banner {
    background: linear-gradient(
      135deg,
      var(--color-accent, #44883e) 0%,
      var(--color-title, #2c5234) 100%
    );
    padding: 60px 20px;
    text-align: center;
  }

  .betty-cta-banner__container {
    max-width: 700px;
    margin: 0 auto;
  }

  .betty-cta-banner__heading {
    font-family: var(--font-heading, 'Eveleth Dot', serif);
    font-size: clamp(24px, 4vw, 36px);
    color: white;
    margin-bottom: 12px;
  }

  .betty-cta-banner__text {
    color: rgba(255, 255, 255, 0.9);
    font-size: 18px;
    margin-bottom: 28px;
  }

  .betty-cta-banner__buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }

  .betty-cta-banner__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 14px 28px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .betty-cta-banner__btn--primary {
    background: white;
    color: var(--color-title, #2c5234);
  }

  .betty-cta-banner__btn--primary:hover {
    background: #fef3c7;
    transform: translateY(-2px);
  }

  .betty-cta-banner__btn--secondary {
    background: transparent;
    color: white;
    border: 2px solid white;
  }

  .betty-cta-banner__btn--secondary:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  /* Bill Trust Section */
  .bill-trust {
    background: #0f172a;
    padding: 48px 20px;
  }

  .bill-trust__container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .bill-trust__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 32px;
  }

  @media (min-width: 768px) {
    .bill-trust__grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .bill-trust__item {
    text-align: center;
  }

  .bill-trust__value {
    font-size: 28px;
    font-weight: 700;
    color: #4ade80;
    margin-bottom: 4px;
  }

  .bill-trust__label {
    font-size: 13px;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Bill CTA Banner */
  .bill-cta-banner {
    background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
    padding: 60px 20px;
    text-align: center;
  }

  .bill-cta-banner__container {
    max-width: 700px;
    margin: 0 auto;
  }

  .bill-cta-banner__heading {
    font-family: var(--font-heading, 'Eveleth Dot', serif);
    font-size: clamp(24px, 4vw, 36px);
    color: white;
    margin-bottom: 12px;
  }

  .bill-cta-banner__text {
    color: #cbd5e1;
    font-size: 18px;
    margin-bottom: 28px;
  }

  .bill-cta-banner__buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }

  .bill-cta-banner__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 14px 28px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .bill-cta-banner__btn--primary {
    background: var(--color-accent, #44883e);
    color: white;
  }

  .bill-cta-banner__btn--primary:hover {
    background: var(--color-accent-hover, #2c5234);
    transform: translateY(-2px);
  }

  .bill-cta-banner__btn--secondary {
    background: transparent;
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.5);
  }

  .bill-cta-banner__btn--secondary:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: white;
  }

  /* Taylor Trust Section */
  .taylor-trust {
    background: #14532d;
    padding: 48px 20px;
  }

  .taylor-trust__container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .taylor-trust__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 32px;
  }

  @media (min-width: 768px) {
    .taylor-trust__grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .taylor-trust__item {
    text-align: center;
  }

  .taylor-trust__value {
    font-size: 28px;
    font-weight: 700;
    color: #86efac;
    margin-bottom: 4px;
  }

  .taylor-trust__label {
    font-size: 13px;
    color: #bbf7d0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Taylor CTA Banner */
  .taylor-cta-banner {
    background: linear-gradient(135deg, #166534 0%, #14532d 100%);
    padding: 60px 20px;
    text-align: center;
  }

  .taylor-cta-banner__container {
    max-width: 700px;
    margin: 0 auto;
  }

  .taylor-cta-banner__heading {
    font-family: var(--font-heading, 'Eveleth Dot', serif);
    font-size: clamp(24px, 4vw, 36px);
    color: white;
    margin-bottom: 12px;
  }

  .taylor-cta-banner__text {
    color: #bbf7d0;
    font-size: 18px;
    margin-bottom: 28px;
  }

  .taylor-cta-banner__buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }

  .taylor-cta-banner__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 14px 28px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .taylor-cta-banner__btn--primary {
    background: white;
    color: #166534;
  }

  .taylor-cta-banner__btn--primary:hover {
    background: #f0fdf4;
    transform: translateY(-2px);
  }

  .taylor-cta-banner__btn--secondary {
    background: transparent;
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.5);
  }

  .taylor-cta-banner__btn--secondary:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: white;
  }
</style>

<script>
  // Client-side persona detection for dynamic updates
  import { getPersonaId, getJourneyStage } from '../lib/persona'

  function updateRealityTunnel() {
    const personaId = getPersonaId()
    const stage = getJourneyStage()

    // Track homepage view with persona context
    if (window.pdPixel) {
      window.pdPixel.track('homepage_view', {
        persona: personaId || 'unknown',
        stage: stage || 'unaware',
        has_persona: Boolean(personaId),
        is_personalized: Boolean(personaId && personaId !== 'general'),
      })
    }
  }

  // Run on load
  document.addEventListener('DOMContentLoaded', updateRealityTunnel)
  if (document.readyState !== 'loading') {
    updateRealityTunnel()
  }

  // Re-run on Astro View Transitions
  document.addEventListener('astro:page-load', updateRealityTunnel)
</script>
