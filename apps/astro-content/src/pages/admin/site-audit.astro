---
/**
 * Site Audit Dashboard
 * Design checklist + Mothership persona scoring + content quality
 */
import AdminLayout from '../../layouts/AdminLayout.astro'

// Content types: dynamic = collection-backed (scannable), index/non-content = skip
type ContentType = 'dynamic' | 'index' | 'non-content'

interface AuditPage {
  route: string
  name: string
  template: string
  priority: 'high' | 'medium' | 'low'
  contentType: ContentType
}

const pageGroups: { name: string; id: string; pages: AuditPage[] }[] = [
  {
    name: 'Homepage',
    id: 'homepage',
    pages: [
      { route: '/', name: 'Homepage', template: 'index.astro', priority: 'high', contentType: 'non-content' },
    ],
  },
  {
    name: 'Podcast',
    id: 'podcast',
    pages: [
      { route: '/podcast/', name: 'Podcast Hub', template: 'podcast/index.astro', priority: 'high', contentType: 'index' },
      { route: '/podcast/[slug]', name: 'Episode Detail', template: 'podcast/[...slug].astro', priority: 'high', contentType: 'dynamic' },
      { route: '/podcast/search', name: 'Podcast Search', template: 'podcast/search.astro', priority: 'medium', contentType: 'non-content' },
      { route: '/podcast/topics/', name: 'Topics Index', template: 'podcast/topics/index.astro', priority: 'medium', contentType: 'index' },
      { route: '/podcast/topics/[slug]', name: 'Topic Detail', template: 'podcast/topics/[slug].astro', priority: 'medium', contentType: 'dynamic' },
      { route: '/podcast/guests/', name: 'Guests Index', template: 'podcast/guests/index.astro', priority: 'low', contentType: 'index' },
    ],
  },
  {
    name: 'Blog',
    id: 'blog',
    pages: [
      { route: '/blog/', name: 'Blog Index', template: 'blog/index.astro', priority: 'high', contentType: 'index' },
      { route: '/blog/[slug]', name: 'Blog Post', template: 'blog/[slug].astro', priority: 'high', contentType: 'dynamic' },
      { route: '/blog/category/[segment]', name: 'Category Archive', template: 'blog/category/[segment].astro', priority: 'medium', contentType: 'non-content' },
    ],
  },
  {
    name: 'Team',
    id: 'team',
    pages: [
      { route: '/team/', name: 'Team Index', template: 'team/index.astro', priority: 'medium', contentType: 'index' },
      { route: '/team/[slug]', name: 'Team Member', template: 'team/[slug].astro', priority: 'medium', contentType: 'dynamic' },
    ],
  },
  {
    name: 'Shop Collections',
    id: 'collections',
    pages: [
      { route: '/collections/', name: 'Collections Index', template: 'collections/index.astro', priority: 'high', contentType: 'index' },
      { route: '/collections/[slug]', name: 'Collection Detail', template: 'collections/[slug].astro', priority: 'high', contentType: 'dynamic' },
    ],
  },
  {
    name: 'Persona Landings',
    id: 'persona',
    pages: [
      { route: '/poultry/', name: 'Poultry Hub', template: 'poultry/index.astro', priority: 'high', contentType: 'non-content' },
      { route: '/poultry/backyard/', name: 'Backyard Betty Landing', template: 'poultry/backyard/index.astro', priority: 'high', contentType: 'non-content' },
      { route: '/poultry/commercial/', name: 'Broiler Bill Landing', template: 'poultry/commercial/index.astro', priority: 'high', contentType: 'non-content' },
      { route: '/lawn/', name: 'Lawn & Garden Hub', template: 'lawn/index.astro', priority: 'high', contentType: 'non-content' },
    ],
  },
  {
    name: 'Surveys (CDP)',
    id: 'surveys',
    pages: [
      { route: '/survey/backyard', name: 'Betty Outcome Survey', template: 'survey/backyard.astro', priority: 'medium', contentType: 'non-content' },
      { route: '/survey/commercial', name: 'Bill Outcome Survey', template: 'survey/commercial.astro', priority: 'medium', contentType: 'non-content' },
    ],
  },
  {
    name: 'Utility',
    id: 'utility',
    pages: [
      { route: '/search', name: 'Global Search', template: 'search.astro', priority: 'low', contentType: 'non-content' },
    ],
  },
  {
    name: 'Admin',
    id: 'admin',
    pages: [
      { route: '/admin/', name: 'Admin Dashboard', template: 'admin/index.astro', priority: 'medium', contentType: 'non-content' },
      { route: '/admin/branding', name: 'Brand Guidelines', template: 'admin/branding.astro', priority: 'low', contentType: 'non-content' },
      { route: '/admin/images', name: 'Image Docs', template: 'admin/images.astro', priority: 'low', contentType: 'non-content' },
      { route: '/admin/cdp/', name: 'CDP Analytics', template: 'admin/cdp/index.astro', priority: 'medium', contentType: 'non-content' },
      { route: '/admin/cdp-guide', name: 'CDP Guide', template: 'admin/cdp-guide.astro', priority: 'low', contentType: 'non-content' },
      { route: '/admin/sales-log', name: 'Sales Log', template: 'admin/sales-log.astro', priority: 'medium', contentType: 'non-content' },
      { route: '/admin/content-quality', name: 'Content Quality', template: 'admin/content-quality.astro', priority: 'medium', contentType: 'non-content' },
      { route: '/admin/site-audit', name: 'Site Audit (this page)', template: 'admin/site-audit.astro', priority: 'low', contentType: 'non-content' },
    ],
  },
]

const totalPages = pageGroups.reduce((sum, g) => sum + g.pages.length, 0)
---

<AdminLayout title="Site Audit" activeNav="/admin/site-audit">
  <header class="page-header">
    <h1 class="page-title">Site Audit</h1>
    <p class="page-subtitle">Design checklist + Mothership persona scoring</p>
  </header>

  <!-- Progress Overview -->
  <div class="progress-card">
    <div class="progress-header">
      <div class="progress-stats">
        <div class="stat">
          <span class="stat-value" id="approved-count">0</span>
          <span class="stat-label">Approved</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="review-count">0</span>
          <span class="stat-label">In Review</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="pending-count">{totalPages}</span>
          <span class="stat-label">Not Started</span>
        </div>
      </div>
      <div class="progress-actions">
        <button class="btn btn-primary" id="scan-all-btn" title="Score all scannable pages via Mothership">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0020 4.77 5.07 5.07 0 0019.91 1S18.73.65 16 2.48a13.38 13.38 0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 005 4.77a5.44 5.44 0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 009 18.13V22" />
          </svg>
          Scan All
        </button>
        <button class="btn btn-secondary" id="export-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Export
        </button>
        <button class="btn btn-secondary" id="reset-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Reset
        </button>
      </div>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
    </div>
    <div class="progress-label">
      <span id="progress-percent">0%</span> complete
    </div>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-item">
      <span class="status-dot not-started"></span>
      <span>Not Started</span>
    </div>
    <div class="legend-item">
      <span class="status-dot in-review"></span>
      <span>In Review</span>
    </div>
    <div class="legend-item">
      <span class="status-dot approved"></span>
      <span>Approved</span>
    </div>
    <div class="legend-item priority">
      <span class="priority-badge high">High</span>
      <span class="priority-badge medium">Med</span>
      <span class="priority-badge low">Low</span>
    </div>
  </div>

  <!-- Page Groups -->
  {
    pageGroups.map((group) => (
      <div class="audit-group" data-group={group.id}>
        <div class="group-header">
          <h2 class="group-title">{group.name}</h2>
          <span class="group-count">{group.pages.length} pages</span>
        </div>
        <div class="audit-table">
          <div class="table-header">
            <div class="col-status">Status</div>
            <div class="col-page">Page</div>
            <div class="col-route">Route</div>
            <div class="col-score">Score</div>
            <div class="col-design">Design</div>
            <div class="col-content">Content</div>
            <div class="col-notes">Notes</div>
            <div class="col-actions">Actions</div>
          </div>
          {group.pages.map((page) => (
            <div>
              <div class="table-row" data-route={page.route} data-content-type={page.contentType}>
                <div class="col-status">
                  <span class="status-dot not-started" data-status-dot />
                </div>
                <div class="col-page">
                  <span class="page-name">{page.name}</span>
                  <span class={`priority-badge ${page.priority}`}>{page.priority}</span>
                </div>
                <div class="col-route">
                  <code>{page.route}</code>
                  <a
                    href={page.route
                      .replace('[slug]', 'example')
                      .replace('[segment]', 'poultry')
                      .replace('[...slug]', 'episode-1')}
                    target="_blank"
                    class="view-link"
                    title="Open page"
                  >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                </div>
                <div class="col-score">
                  {page.contentType === 'dynamic' ? (
                    <button class="scan-btn" data-action="scan" title="Score via Mothership">Scan</button>
                  ) : (
                    <span class="score-na">N/A</span>
                  )}
                </div>
                <div class="col-design">
                  <select class="design-select" data-field="design">
                    <option value="not-started">Not Started</option>
                    <option value="in-review">In Review</option>
                    <option value="approved">Approved</option>
                  </select>
                </div>
                <div class="col-content">
                  <select class="content-select" data-field="content">
                    <option value="not-started">Not Started</option>
                    <option value="needs-persona">Needs Persona</option>
                    <option value="needs-quality">Needs Quality Check</option>
                    <option value="approved">Approved</option>
                  </select>
                </div>
                <div class="col-notes">
                  <input type="text" class="notes-input" data-field="notes" placeholder="Add notes..." />
                </div>
                <div class="col-actions">
                  <button class="action-btn" data-action="clear" title="Clear row">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
              <!-- Expandable scan detail panel -->
              <div class="scan-details" data-details-for={page.route}></div>
            </div>
          ))}
        </div>
      </div>
    ))
  }

  <!-- Mothership Integration Status -->
  <div class="card integration-status">
    <div class="card-header">
      <h2 class="card-title">Mothership Integration</h2>
      <span class="badge badge-success">Live</span>
    </div>
    <p>Content scoring powered by Mothership persona vectors + OpenAI embeddings.</p>
    <div class="integration-stats">
      <div class="stat">
        <span class="stat-value" id="scanned-count">0</span>
        <span class="stat-label">Routes Scanned</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="avg-alignment">--</span>
        <span class="stat-label">Avg Alignment</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="total-entries">0</span>
        <span class="stat-label">Entries Scored</span>
      </div>
    </div>
    <p style="margin-top: 12px; color: var(--text-secondary); font-size: 13px;">
      Two-axis evaluation: <strong>Persona</strong> (WHO does content speak to?) and <strong>Quality</strong> (is it structurally sound?). Never blended.
    </p>
  </div>

  <!-- Scan progress bar (sticky bottom, hidden by default) -->
  <div class="scan-progress" id="scan-progress" style="display: none;">
    <div class="scan-progress-inner">
      <span class="scan-progress-label" id="scan-progress-label">Scanning...</span>
      <div class="scan-progress-bar-container">
        <div class="scan-progress-bar" id="scan-progress-bar" style="width: 0%"></div>
      </div>
      <span class="scan-progress-count" id="scan-progress-count">0/0</span>
      <button class="btn btn-secondary btn-sm" id="scan-cancel-btn">Cancel</button>
    </div>
  </div>
</AdminLayout>

<style>
  /* ========== Progress Card ========== */
  .progress-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
  }
  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .progress-stats { display: flex; gap: 32px; }
  .stat { text-align: center; }
  .stat-value {
    display: block;
    font-size: 28px;
    font-weight: 600;
    color: var(--text);
    line-height: 1;
  }
  .stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .progress-actions { display: flex; gap: 8px; }
  .progress-bar-container {
    height: 8px;
    background: var(--surface-alt);
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 4px;
    transition: width 0.3s ease;
  }
  .progress-label {
    margin-top: 8px;
    font-size: 13px;
    color: var(--text-secondary);
  }
  #progress-percent { font-weight: 600; color: var(--accent); }

  /* ========== Legend ========== */
  .legend {
    display: flex;
    gap: 24px;
    margin-bottom: 24px;
    flex-wrap: wrap;
    align-items: center;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: var(--text-secondary);
  }
  .legend-item.priority { margin-left: auto; gap: 8px; }

  /* ========== Status & Priority ========== */
  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .status-dot.not-started { background: var(--border); }
  .status-dot.in-review { background: var(--warning); }
  .status-dot.approved { background: var(--success); }

  .priority-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }
  .priority-badge.high { background: #fee2e2; color: #991b1b; }
  .priority-badge.medium { background: #fef3c7; color: #92400e; }
  .priority-badge.low { background: #f3f4f6; color: #6b7280; }

  /* ========== Audit Table ========== */
  .audit-group {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 20px;
    overflow: hidden;
  }
  .group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: var(--surface-alt);
    border-bottom: 1px solid var(--border);
  }
  .group-title { font-size: 14px; font-weight: 600; color: var(--text); }
  .group-count { font-size: 12px; color: var(--text-secondary); }
  .audit-table { font-size: 13px; }

  .table-header,
  .table-row {
    display: grid;
    grid-template-columns: 50px 160px 1fr 80px 120px 140px 1fr 50px;
    gap: 12px;
    padding: 12px 20px;
    align-items: center;
  }
  .table-header {
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .table-row {
    border-bottom: 1px solid var(--border-subtle);
  }
  .table-row:hover { background: var(--bg); }

  .col-status { display: flex; justify-content: center; }
  .col-page { display: flex; align-items: center; gap: 8px; }
  .page-name { font-weight: 500; color: var(--text); }
  .col-route { display: flex; align-items: center; gap: 8px; }
  .col-route code {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--surface-alt);
    padding: 2px 6px;
    border-radius: 3px;
  }
  .col-score { display: flex; justify-content: center; }
  .view-link { color: var(--text-tertiary); transition: color 0.15s; }
  .view-link:hover { color: var(--accent); }
  .view-link svg { width: 14px; height: 14px; }

  .design-select,
  .content-select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 12px;
    background: var(--surface);
    cursor: pointer;
  }
  .design-select:focus,
  .content-select:focus {
    outline: none;
    border-color: var(--accent);
  }
  .notes-input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 12px;
    background: var(--surface);
  }
  .notes-input:focus { outline: none; border-color: var(--accent); }

  .action-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: transparent;
    color: var(--text-tertiary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.15s;
  }
  .action-btn:hover { background: var(--error-light); color: var(--error); }
  .action-btn svg { width: 14px; height: 14px; }

  /* ========== Score Column ========== */
  .scan-btn {
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
    background: var(--surface);
    color: var(--accent);
    border: 1px solid var(--accent);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.15s;
  }
  .scan-btn:hover { background: var(--accent); color: white; }
  .scan-btn:disabled { opacity: 0.5; cursor: wait; }
  .scan-btn.scanning { animation: pulse 1.5s infinite; }

  .score-na {
    font-size: 11px;
    color: var(--text-tertiary);
  }

  .score-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 28px;
    padding: 0 8px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.15s;
    border: none;
  }
  .score-badge:hover { transform: scale(1.1); }
  .score-badge.score-high { background: #dcfce7; color: #166534; }
  .score-badge.score-mid { background: #fef3c7; color: #92400e; }
  .score-badge.score-low { background: #fee2e2; color: #991b1b; }
  .score-badge.score-confused { background: #ede9fe; color: #5b21b6; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* ========== Scan Detail Panel ========== */
  .scan-details {
    display: none;
    padding: 16px 20px;
    background: var(--surface-alt);
    border-bottom: 1px solid var(--border-subtle);
  }
  .scan-details.open { display: block; }

  .scan-details-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 12px;
  }

  .detail-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
  }
  .detail-card-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-tertiary);
    margin-bottom: 6px;
  }
  .detail-card-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
  }
  .detail-card-sub {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
  }

  .persona-bar-group { margin-top: 8px; }
  .persona-bar-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }
  .persona-bar-label {
    font-size: 10px;
    font-weight: 600;
    width: 50px;
    flex-shrink: 0;
    color: var(--text-secondary);
  }
  .persona-bar-track {
    flex: 1;
    height: 8px;
    background: var(--surface-alt);
    border-radius: 4px;
    overflow: hidden;
  }
  .persona-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
  }
  .persona-bar-fill.high { background: #16a34a; }
  .persona-bar-fill.mid { background: #eab308; }
  .persona-bar-fill.low { background: #dc2626; }
  .persona-bar-pct {
    font-size: 10px;
    font-weight: 600;
    width: 30px;
    text-align: right;
    color: var(--text-secondary);
  }

  .detail-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }
  .detail-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
  }
  .detail-badge.blocker { background: #fee2e2; color: #991b1b; }
  .detail-badge.warning { background: #fef3c7; color: #92400e; }
  .detail-badge.ok { background: #dcfce7; color: #166534; }
  .detail-badge.info { background: #dbeafe; color: #1e40af; }

  /* ========== Detail Panel: Summary ========== */
  .detail-summary {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 16px;
    line-height: 1.5;
  }

  /* ========== Detail Panel: Fixes List ========== */
  .detail-fixes {
    margin-bottom: 16px;
    padding: 12px 16px;
    background: #fffbeb;
    border: 1px solid #fde68a;
    border-radius: var(--radius-sm);
  }
  .detail-fixes-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #92400e;
    margin-bottom: 8px;
  }
  .detail-fixes ol {
    margin: 0;
    padding-left: 20px;
    font-size: 13px;
    color: #78350f;
    line-height: 1.6;
  }
  .detail-fixes li { margin-bottom: 2px; }

  /* ========== Detail Panel: Entry Table ========== */
  .entry-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-bottom: 16px;
  }
  .entry-table th {
    text-align: left;
    padding: 8px 10px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-tertiary);
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
  }
  .entry-table td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-subtle);
    color: var(--text);
    vertical-align: middle;
  }
  .entry-table tr:hover td { background: var(--bg); }
  .entry-table .entry-title a {
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
  }
  .entry-table .entry-title a:hover { text-decoration: underline; }
  .entry-table .cell-red { color: #dc2626; font-weight: 600; }
  .entry-table .cell-amber { color: #d97706; font-weight: 600; }
  .entry-table .cell-green { color: #16a34a; }
  .entry-table .cell-muted { color: var(--text-tertiary); }
  .entry-table .gap-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
  }
  .entry-table .gap-orphan { background: #fee2e2; color: #991b1b; }
  .entry-table .gap-weak { background: #fef3c7; color: #92400e; }
  .entry-table .gap-confused { background: #ede9fe; color: #5b21b6; }
  .entry-table .gap-ok { background: #dcfce7; color: #166534; }

  /* ========== Detail Panel: Persona Chart ========== */
  .persona-chart {
    margin-top: 12px;
    padding: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
  }
  .persona-chart-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-tertiary);
    margin-bottom: 10px;
  }

  /* ========== Integration Status Card ========== */
  .integration-status { background: var(--surface); }
  .integration-status p {
    font-size: 14px;
    color: var(--text);
    margin-bottom: 12px;
  }
  .integration-stats {
    display: flex;
    gap: 32px;
    margin-top: 16px;
  }
  .integration-status a { color: var(--accent); }

  /* ========== Scan Progress Bar (Sticky Bottom) ========== */
  .scan-progress {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: var(--surface);
    border-top: 2px solid var(--accent);
    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
  }
  .scan-progress-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .scan-progress-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
  }
  .scan-progress-bar-container {
    flex: 1;
    height: 8px;
    background: var(--surface-alt);
    border-radius: 4px;
    overflow: hidden;
  }
  .scan-progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 4px;
    transition: width 0.3s ease;
  }
  .scan-progress-count {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    white-space: nowrap;
  }
  .btn-sm { padding: 4px 12px; font-size: 12px; }

  /* ========== Responsive ========== */
  @media (max-width: 1100px) {
    .table-header,
    .table-row {
      grid-template-columns: 40px 140px 1fr 70px 100px 120px 50px;
    }
    .col-notes { display: none; }
    .scan-details-grid { grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 800px) {
    .table-header,
    .table-row {
      grid-template-columns: 40px 1fr 60px 100px 100px 40px;
    }
    .col-route { display: none; }
    .scan-details-grid { grid-template-columns: 1fr; }
  }
</style>

<script is:inline>
  // =========================================================================
  // CONFIG
  // =========================================================================

  var STORAGE_KEY = 'southland_site_audit'
  var CURRENT_SCAN_VERSION = 2

  // =========================================================================
  // STATE
  // =========================================================================

  var scanCancelled = false
  var sessionScanCount = 0
  // Full scan results cached in memory for detail panel rendering
  var scanResults = {}

  function loadState() {
    try {
      var saved = localStorage.getItem(STORAGE_KEY)
      return saved ? JSON.parse(saved) : {}
    } catch (e) {
      return {}
    }
  }

  function saveState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state))
  }

  // =========================================================================
  // ROW STATUS
  // =========================================================================

  function getRowStatus(design, content) {
    if (design === 'approved' && (content === 'approved' || content === 'not-started')) return 'approved'
    if (design === 'in-review' || content === 'needs-persona' || content === 'needs-quality') return 'in-review'
    return 'not-started'
  }

  function updateProgress() {
    var state = loadState()
    var rows = document.querySelectorAll('.table-row')
    var approved = 0, inReview = 0, notStarted = 0

    rows.forEach(function(row) {
      var route = row.dataset.route
      var data = state[route] || {}
      var status = getRowStatus(data.design || 'not-started', data.content || 'not-started')
      var dot = row.querySelector('[data-status-dot]')
      if (dot) dot.className = 'status-dot ' + status
      if (status === 'approved') approved++
      else if (status === 'in-review') inReview++
      else notStarted++
    })

    var total = rows.length
    var percent = total > 0 ? Math.round((approved / total) * 100) : 0
    document.getElementById('approved-count').textContent = approved
    document.getElementById('review-count').textContent = inReview
    document.getElementById('pending-count').textContent = notStarted
    document.getElementById('progress-bar').style.width = percent + '%'
    document.getElementById('progress-percent').textContent = percent + '%'

    updateIntegrationStats()
  }

  // =========================================================================
  // INTEGRATION STATS
  // =========================================================================

  function updateIntegrationStats() {
    var state = loadState()
    var scanned = 0, totalAlignment = 0, totalEntries = 0

    Object.values(state).forEach(function(data) {
      if (data.scan && data.scan.avgAlignment !== undefined) {
        scanned++
        totalAlignment += data.scan.avgAlignment
        totalEntries += data.scan.scoredCount || 0
      }
    })

    document.getElementById('scanned-count').textContent = scanned
    document.getElementById('avg-alignment').textContent = scanned > 0 ? Math.round(totalAlignment / scanned) + '%' : '--'
    document.getElementById('total-entries').textContent = totalEntries
  }

  // =========================================================================
  // SCAN ROUTE
  // =========================================================================

  function scanRoute(route) {
    return fetch('/api/site-audit/scan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ route: route }),
    })
    .then(function(res) { return res.json() })
    .then(function(result) {
      sessionScanCount++
      if (result && result.entries) {
        scanResults[route] = result
      }
      return result
    })
  }

  // =========================================================================
  // HELPERS
  // =========================================================================

  function getBarClass(pct) {
    if (pct >= 60) return 'high'
    if (pct >= 40) return 'mid'
    return 'low'
  }

  function personaInitial(name) {
    if (!name) return '?'
    return name.split(' ').pop().charAt(0).toUpperCase()
  }

  function badgeColor(alignment) {
    if (alignment >= 60) return 'score-high'
    if (alignment >= 40) return 'score-mid'
    return 'score-low'
  }

  // =========================================================================
  // RENDER SCORE BADGE — "B 68%" format
  // =========================================================================

  function renderScoreBadge(row, result) {
    var scoreCol = row.querySelector('.col-score')
    if (!result || result.scannable === false) return

    var agg = result.aggregate
    var p = agg.persona
    var label, cls

    if (!p) {
      label = '--'
      cls = 'score-low'
    } else if (p.unclearCount === result.scoredCount) {
      // All entries unclear
      label = '?'
      cls = 'score-confused'
    } else {
      var initial = personaInitial(p.primaryAudience)
      label = initial + ' ' + p.avgAlignment + '%'
      cls = badgeColor(p.avgAlignment)
    }

    scoreCol.innerHTML = '<button class="score-badge ' + cls + '" data-action="toggle-details" title="Click to expand">' +
      label + '</button>'
  }

  // =========================================================================
  // RENDER DETAIL PANEL — Summary → Fixes → Entry Table → Persona Chart
  // =========================================================================

  function renderDetailPanel(route, result) {
    var panel = document.querySelector('[data-details-for="' + route + '"]')
    if (!panel || result.scannable === false) return

    var entries = result.entries || []
    var agg = result.aggregate
    var p = agg.persona
    var q = agg.quality
    var g = agg.gap
    var html = ''

    // === 1. SUMMARY SENTENCE ===
    var summary = result.scoredCount + ' entries scanned.'
    if (p) {
      if (p.unclearCount === result.scoredCount) {
        summary += ' No clear audience — content is too generic for any persona.'
      } else {
        summary += ' Speaks to <strong>' + p.primaryAudience + '</strong> at ' + p.avgAlignment + '% avg alignment.'
        // Top quality issue
        if (q.noInternalLinks > 0) {
          summary += ' ' + q.noInternalLinks + ' of ' + result.scoredCount + ' have zero internal links.'
        } else if (q.stubbedCount > 0) {
          summary += ' ' + q.stubbedCount + ' are stubs (< 150 words).'
        } else if (q.missingMeta > 0) {
          summary += ' ' + q.missingMeta + ' missing meta descriptions.'
        }
      }
    } else {
      summary += ' Persona scoring unavailable.'
    }
    html += '<div class="detail-summary">' + summary + '</div>'

    // === 2. TOP FIXES (max 4, auto-derived from entries) ===
    var fixes = generateFixes(entries, result.scoredCount)
    if (fixes.length > 0) {
      html += '<div class="detail-fixes">'
      html += '<div class="detail-fixes-title">Top Fixes</div>'
      html += '<ol>'
      fixes.forEach(function(fix) { html += '<li>' + fix + '</li>' })
      html += '</ol></div>'
    }

    // === 3. PER-ENTRY TABLE (weakest first) ===
    if (entries.length > 0) {
      // Sort: most issues first (unclear persona, stub, no links, no meta)
      var sorted = entries.slice().sort(function(a, b) {
        return issueCount(b) - issueCount(a)
      })

      html += '<table class="entry-table">'
      html += '<thead><tr>' +
        '<th>Entry</th>' +
        '<th>Audience</th>' +
        '<th>Align</th>' +
        '<th>Words</th>' +
        '<th>Read.</th>' +
        '<th>Links</th>' +
        '<th>H2s</th>' +
        '<th>Gap</th>' +
        '</tr></thead><tbody>'

      sorted.forEach(function(entry) {
        var ep = entry.persona
        var eq = entry.quality
        var eg = entry.gap

        // Audience cell
        var audienceCell, alignCell
        if (!ep) {
          audienceCell = '<span class="cell-muted">--</span>'
          alignCell = '<span class="cell-muted">--</span>'
        } else if (ep.unclear) {
          audienceCell = '<span class="cell-amber">unclear</span>'
          alignCell = '<span class="cell-muted">--</span>'
        } else {
          audienceCell = ep.audience
          var alignCls = ep.alignment >= 60 ? 'cell-green' : (ep.alignment >= 40 ? 'cell-amber' : 'cell-red')
          alignCell = '<span class="' + alignCls + '">' + ep.alignment + '%</span>'
        }

        // Words
        var wordsCls = eq.stubbed ? 'cell-red' : (eq.wordCount < 300 ? 'cell-amber' : '')
        var wordsCell = '<span class="' + wordsCls + '">' + eq.wordCount + '</span>'

        // Readability
        var readCell = eq.readability.gradeLevel !== 'unknown'
          ? eq.readability.gradeLevel
          : '<span class="cell-muted">--</span>'

        // Links
        var linkTotal = eq.internalLinks + eq.externalLinks
        var linksCls = linkTotal === 0 ? 'cell-red' : ''
        var linksCell = '<span class="' + linksCls + '">' + linkTotal + '</span>'

        // Headings
        var h2Cell = eq.headings.h2 > 0
          ? eq.headings.h2 + ' H2'
          : '<span class="cell-muted">--</span>'
        if (!eq.headings.properStructure && eq.headings.h2 > 0) {
          h2Cell = '<span class="cell-amber">' + h2Cell + '</span>'
        }

        // Gap
        var gapCell = '<span class="cell-muted">--</span>'
        if (eg) {
          var gapCls = 'gap-' + eg.status.toLowerCase()
          gapCell = '<span class="gap-badge ' + gapCls + '">' + eg.status + '</span>'
        }

        html += '<tr>' +
          '<td class="entry-title"><a href="' + entry.url + '" target="_blank">' + entry.title + '</a></td>' +
          '<td>' + audienceCell + '</td>' +
          '<td>' + alignCell + '</td>' +
          '<td>' + wordsCell + '</td>' +
          '<td>' + readCell + '</td>' +
          '<td>' + linksCell + '</td>' +
          '<td>' + h2Cell + '</td>' +
          '<td>' + gapCell + '</td>' +
          '</tr>'
      })

      html += '</tbody></table>'
    }

    // === 4. PERSONA CHART ===
    if (p && p.unclearCount < result.scoredCount) {
      // Compute average scores across all entries that have persona data
      var billTotal = 0, bettyTotal = 0, taylorTotal = 0, personaCount = 0
      entries.forEach(function(e) {
        if (e.persona) {
          billTotal += e.persona.scores.bill
          bettyTotal += e.persona.scores.betty
          taylorTotal += e.persona.scores.taylor
          personaCount++
        }
      })
      if (personaCount > 0) {
        var avgBill = Math.round(billTotal / personaCount)
        var avgBetty = Math.round(bettyTotal / personaCount)
        var avgTaylor = Math.round(taylorTotal / personaCount)

        html += '<div class="persona-chart">'
        html += '<div class="persona-chart-title">Persona Alignment (avg across ' + personaCount + ' entries)</div>'
        html += '<div class="persona-bar-group">'
        html += renderPersonaBar('Bill', avgBill)
        html += renderPersonaBar('Betty', avgBetty)
        html += renderPersonaBar('Taylor', avgTaylor)
        html += '</div>'

        // List unclear entries
        var unclearEntries = entries.filter(function(e) { return e.persona && e.persona.unclear })
        if (unclearEntries.length > 0) {
          html += '<div style="margin-top:8px;font-size:12px;color:var(--text-secondary);">'
          html += '<strong>Unclear audience:</strong> '
          html += unclearEntries.map(function(e) { return e.title }).join(', ')
          html += '</div>'
        }

        html += '</div>'
      }
    }

    panel.innerHTML = html
  }

  function renderPersonaBar(label, pct) {
    var cls = getBarClass(pct)
    return '<div class="persona-bar-row">' +
      '<span class="persona-bar-label">' + label + '</span>' +
      '<div class="persona-bar-track"><div class="persona-bar-fill ' + cls + '" style="width:' + pct + '%"></div></div>' +
      '<span class="persona-bar-pct">' + pct + '%</span>' +
    '</div>'
  }

  // =========================================================================
  // ISSUE COUNTING (for sort order)
  // =========================================================================

  function issueCount(entry) {
    var count = 0
    var q = entry.quality
    if (q.stubbed) count += 2
    if (q.internalLinks + q.externalLinks === 0) count += 2
    if (!q.hasMetaDescription) count++
    if (!q.headings.properStructure) count++
    if (entry.persona && entry.persona.unclear) count += 2
    if (!entry.persona) count++
    if (entry.gap && entry.gap.status === 'ORPHAN') count++
    return count
  }

  // =========================================================================
  // FIX GENERATION — auto-derived from entry data
  // =========================================================================

  function generateFixes(entries, scoredCount) {
    var fixes = []

    // 1. Entries with 0 links
    var noLinks = entries.filter(function(e) {
      return e.quality.internalLinks + e.quality.externalLinks === 0
    })
    if (noLinks.length > 0) {
      var names = noLinks.slice(0, 4).map(function(e) { return e.title })
      var suffix = noLinks.length > 4 ? ' + ' + (noLinks.length - 4) + ' more' : ''
      fixes.push('Add internal links to <strong>' + names.join('</strong>, <strong>') + '</strong>' + suffix + ' — zero links to hub or product pages.')
    }

    // 2. Stubs (< 150 words)
    var stubs = entries.filter(function(e) { return e.quality.stubbed })
    if (stubs.length > 0) {
      var names2 = stubs.slice(0, 3).map(function(e) { return e.title + ' (' + e.quality.wordCount + ' words)' })
      fixes.push('Expand <strong>' + names2.join('</strong>, <strong>') + '</strong> — under 150 words, flagged as stub.')
    }

    // 3. Missing meta descriptions
    var noMeta = entries.filter(function(e) { return !e.quality.hasMetaDescription })
    if (noMeta.length > 0) {
      var names3 = noMeta.slice(0, 4).map(function(e) { return e.title })
      fixes.push('Add meta descriptions to <strong>' + names3.join('</strong>, <strong>') + '</strong> — missing entirely.')
    }

    // 4. Bad heading structure
    var badHeadings = entries.filter(function(e) {
      return !e.quality.headings.properStructure && e.quality.wordCount >= 150
    })
    if (badHeadings.length > 0) {
      var names4 = badHeadings.slice(0, 3).map(function(e) { return e.title })
      fixes.push('Fix heading structure in <strong>' + names4.join('</strong>, <strong>') + '</strong> — missing H2s or multiple H1s.')
    }

    // 5. Unclear persona (all < 30%)
    var unclear = entries.filter(function(e) { return e.persona && e.persona.unclear })
    if (unclear.length > 0 && fixes.length < 4) {
      var names5 = unclear.slice(0, 3).map(function(e) { return e.title })
      fixes.push('<strong>' + names5.join('</strong>, <strong>') + '</strong> have no clear audience (all personas < 30%). Rewrite to target a specific persona.')
    }

    return fixes.slice(0, 4)
  }

  // =========================================================================
  // AUTO-SET CONTENT STATUS — two-axis rules
  // =========================================================================

  function autoSetContentStatus(route, result) {
    if (!result || result.scannable === false) return

    var agg = result.aggregate
    var p = agg.persona
    var q = agg.quality
    var contentStatus = 'not-started'

    // Count quality checks passed (6 total)
    var qualityPassed = 0
    if (q.avgWordCount >= 300) qualityPassed++
    if (q.missingMeta === 0) qualityPassed++
    if (q.noInternalLinks === 0) qualityPassed++
    if (q.badHeadingsCount === 0) qualityPassed++
    if (q.avgReadability >= 50) qualityPassed++
    if (q.stubbedCount === 0) qualityPassed++

    if (p && p.avgAlignment >= 60 && qualityPassed >= 4) {
      contentStatus = 'approved'
    } else if (!p || p.avgAlignment < 40 || p.unclearCount > 0) {
      contentStatus = 'needs-persona'
    } else if (qualityPassed <= 2) {
      contentStatus = 'needs-quality'
    }

    var row = document.querySelector('.table-row[data-route="' + route + '"]')
    if (!row) return

    var contentSelect = row.querySelector('[data-field="content"]')
    if (contentSelect) {
      contentSelect.value = contentStatus
      contentSelect.dispatchEvent(new Event('change'))
    }
  }

  // =========================================================================
  // CACHE SCAN RESULT — two-axis format
  // =========================================================================

  function cacheScanResult(route, result) {
    if (result.scannable === false) return
    var state = loadState()
    if (!state[route]) state[route] = {}

    var p = result.aggregate.persona
    var q = result.aggregate.quality
    var g = result.aggregate.gap

    state[route].scan = {
      scannedAt: result.scannedAt,
      scanVersion: result.scanVersion,
      scoredCount: result.scoredCount,
      totalEntries: result.entryCount,
      // Persona axis
      primaryAudience: p ? p.primaryAudience : null,
      avgAlignment: p ? p.avgAlignment : null,
      unclearCount: p ? p.unclearCount : null,
      // Quality axis
      avgWordCount: q.avgWordCount,
      missingMeta: q.missingMeta,
      noInternalLinks: q.noInternalLinks,
      stubbedCount: q.stubbedCount,
      // Gap
      gap: g,
      // Full entries for detail panel restore
      entries: result.entries,
    }
    saveState(state)
  }

  // =========================================================================
  // RESTORE CACHED SCANS ON LOAD
  // =========================================================================

  function restoreCachedScans() {
    var state = loadState()
    Object.keys(state).forEach(function(route) {
      var data = state[route]
      if (!data.scan) return

      var row = document.querySelector('.table-row[data-route="' + route + '"]')
      if (!row) return

      var scoreCol = row.querySelector('.col-score')
      if (!scoreCol) return

      var scan = data.scan
      var stale = scan.scanVersion < CURRENT_SCAN_VERSION
      var label, cls

      if (!scan.primaryAudience) {
        label = '--'
        cls = 'score-low'
      } else if (scan.unclearCount === scan.scoredCount) {
        label = '?'
        cls = 'score-confused'
      } else {
        var initial = personaInitial(scan.primaryAudience)
        label = initial + ' ' + scan.avgAlignment + '%'
        cls = badgeColor(scan.avgAlignment)
      }

      if (stale) label += '*'

      scoreCol.innerHTML = '<button class="score-badge ' + cls + '" data-action="toggle-details" title="' +
        (stale ? 'Stale — re-scan available' : 'Click to expand') + '">' +
        label + '</button>'

      // Restore full result for detail panel
      if (scan.entries) {
        scanResults[route] = {
          scannable: true,
          scoredCount: scan.scoredCount,
          entryCount: scan.totalEntries,
          entries: scan.entries,
          aggregate: {
            persona: scan.primaryAudience ? {
              primaryAudience: scan.primaryAudience,
              avgAlignment: scan.avgAlignment,
              unclearCount: scan.unclearCount,
            } : null,
            quality: {
              avgWordCount: scan.avgWordCount,
              missingMeta: scan.missingMeta,
              noInternalLinks: scan.noInternalLinks,
              stubbedCount: scan.stubbedCount,
              avgReadability: 0,
              badHeadingsCount: 0,
            },
            gap: scan.gap,
          },
        }
      }
    })
  }

  // =========================================================================
  // SCAN ALL
  // =========================================================================

  function scanAll() {
    var rows = document.querySelectorAll('.table-row[data-content-type="dynamic"]')
    var routes = []
    rows.forEach(function(row) { routes.push(row.dataset.route) })

    if (routes.length === 0) return

    scanCancelled = false
    var progressEl = document.getElementById('scan-progress')
    var progressBar = document.getElementById('scan-progress-bar')
    var progressCount = document.getElementById('scan-progress-count')
    var progressLabel = document.getElementById('scan-progress-label')
    var scanAllBtn = document.getElementById('scan-all-btn')

    progressEl.style.display = ''
    scanAllBtn.disabled = true
    var completed = 0

    function next() {
      if (scanCancelled || completed >= routes.length) {
        progressEl.style.display = 'none'
        scanAllBtn.disabled = false
        updateProgress()
        return
      }

      progressLabel.textContent = 'Scanning ' + routes[completed] + '...'

      var route = routes[completed]
      var row = document.querySelector('.table-row[data-route="' + route + '"]')
      var scanBtn = row ? row.querySelector('.scan-btn, .score-badge') : null
      if (scanBtn) scanBtn.classList.add('scanning')

      scanRoute(route)
        .then(function(result) {
          if (result && result.scannable !== false && result.entries) {
            renderScoreBadge(row, result)
            renderDetailPanel(route, result)
            autoSetContentStatus(route, result)
            cacheScanResult(route, result)
          }
        })
        .catch(function(err) {
          console.error('Scan failed for ' + route + ':', err)
        })
        .finally(function() {
          if (scanBtn) scanBtn.classList.remove('scanning')
          completed++
          var pct = Math.round((completed / routes.length) * 100)
          progressBar.style.width = pct + '%'
          progressCount.textContent = completed + '/' + routes.length
          setTimeout(next, 500)
        })
    }

    progressCount.textContent = '0/' + routes.length
    next()
  }

  // =========================================================================
  // INIT
  // =========================================================================

  function init() {
    var state = loadState()

    // Populate fields from saved state
    document.querySelectorAll('.table-row').forEach(function(row) {
      var route = row.dataset.route
      var data = state[route] || {}
      var designSelect = row.querySelector('[data-field="design"]')
      var contentSelect = row.querySelector('[data-field="content"]')
      var notesInput = row.querySelector('[data-field="notes"]')
      if (data.design && designSelect) designSelect.value = data.design
      if (data.content && contentSelect) contentSelect.value = data.content
      if (data.notes && notesInput) notesInput.value = data.notes
    })

    // Change listeners for dropdowns and notes
    document.querySelectorAll('.design-select, .content-select, .notes-input').forEach(function(el) {
      el.addEventListener('change', function() {
        var row = this.closest('.table-row')
        var route = row.dataset.route
        var field = this.dataset.field
        var st = loadState()
        if (!st[route]) st[route] = {}
        st[route][field] = this.value
        saveState(st)
        updateProgress()
      })
    })

    // Clear row button
    document.querySelectorAll('[data-action="clear"]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var row = this.closest('.table-row')
        var route = row.dataset.route
        var st = loadState()
        delete st[route]
        saveState(st)
        row.querySelector('[data-field="design"]').value = 'not-started'
        row.querySelector('[data-field="content"]').value = 'not-started'
        row.querySelector('[data-field="notes"]').value = ''
        // Reset score column
        if (row.dataset.contentType === 'dynamic') {
          row.querySelector('.col-score').innerHTML = '<button class="scan-btn" data-action="scan" title="Score via Mothership">Scan</button>'
        }
        // Close detail panel
        var panel = document.querySelector('[data-details-for="' + route + '"]')
        if (panel) { panel.classList.remove('open'); panel.innerHTML = '' }
        delete scanResults[route]
        updateProgress()
      })
    })

    // Scan button (per-row) and toggle — delegated
    document.addEventListener('click', function(e) {
      var scanBtn = e.target.closest('[data-action="scan"]')
      if (scanBtn) {
        var row = scanBtn.closest('.table-row')
        var route = row.dataset.route
        scanBtn.disabled = true
        scanBtn.classList.add('scanning')
        scanBtn.textContent = '...'

        scanRoute(route)
          .then(function(result) {
            if (result && result.scannable !== false && result.entries) {
              renderScoreBadge(row, result)
              renderDetailPanel(route, result)
              autoSetContentStatus(route, result)
              cacheScanResult(route, result)
              // Auto-open detail panel
              var panel = document.querySelector('[data-details-for="' + route + '"]')
              if (panel) panel.classList.add('open')
            }
          })
          .catch(function(err) {
            console.error('Scan error:', err)
            scanBtn.textContent = 'Err'
            scanBtn.disabled = false
            scanBtn.classList.remove('scanning')
          })
          .finally(function() {
            updateProgress()
          })
      }

      // Toggle detail panel
      var toggleBtn = e.target.closest('[data-action="toggle-details"]')
      if (toggleBtn) {
        var row2 = toggleBtn.closest('.table-row')
        var route2 = row2.dataset.route
        var panel = document.querySelector('[data-details-for="' + route2 + '"]')
        if (panel) {
          // Re-render from cached result if panel is empty
          if (!panel.innerHTML && scanResults[route2]) {
            renderDetailPanel(route2, scanResults[route2])
          }
          panel.classList.toggle('open')
        }
      }
    })

    // Scan All button
    document.getElementById('scan-all-btn').addEventListener('click', scanAll)

    // Cancel scan
    document.getElementById('scan-cancel-btn').addEventListener('click', function() {
      scanCancelled = true
    })

    // Export button
    document.getElementById('export-btn').addEventListener('click', function() {
      var st = loadState()
      var blob = new Blob([JSON.stringify(st, null, 2)], { type: 'application/json' })
      var url = URL.createObjectURL(blob)
      var a = document.createElement('a')
      a.href = url
      a.download = 'site-audit-' + new Date().toISOString().split('T')[0] + '.json'
      a.click()
      URL.revokeObjectURL(url)
    })

    // Reset button
    document.getElementById('reset-btn').addEventListener('click', function() {
      if (confirm('Reset all audit progress? This cannot be undone.')) {
        localStorage.removeItem(STORAGE_KEY)
        scanResults = {}
        location.reload()
      }
    })

    // Restore cached scans and update progress
    restoreCachedScans()
    updateProgress()
  }

  init()
</script>
