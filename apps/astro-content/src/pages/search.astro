---
/**
 * Search Results Page
 *
 * Displays semantic search results from content and products.
 * Includes "Was this helpful?" feedback component.
 */
import BaseLayout from '../layouts/BaseLayout.astro';
import SearchBar from '../components/cdp/SearchBar.astro';
import SearchFeedback from '../components/cdp/SearchFeedback.astro';
import { semanticSearch } from '../lib/search';

// Get search query from URL
const query = Astro.url.searchParams.get('q')?.trim() || '';

// Perform search if query exists
let searchResults = null;
if (query) {
  searchResults = await semanticSearch(query);
}

const title = query ? `Search: ${query}` : 'Search';
const description = query
  ? `Search results for "${query}" - Find solutions for your poultry and lawn needs`
  : 'Search Southland Organics for solutions to your poultry and lawn care needs';
---

<BaseLayout title={title} description={description} noIndex>
  <main class="search-page">
    <div class="search-page__container">
      <!-- Search Header -->
      <header class="search-page__header">
        <h1 class="search-page__title">
          {query ? `Results for "${query}"` : 'What can we help you solve?'}
        </h1>
        <div class="search-page__search-bar">
          <SearchBar
            size="large"
            placeholder="Describe your problem..."
            showSuggestions={!query}
          />
        </div>
      </header>

      <!-- Results -->
      {searchResults && searchResults.totalCount > 0 && (
        <section class="search-results">
          <p class="search-results__count">
            Found {searchResults.totalCount} result{searchResults.totalCount !== 1 ? 's' : ''}
          </p>

          <!-- Content Results -->
          {searchResults.content.length > 0 && (
            <div class="search-results__section">
              <h2 class="search-results__section-title">Articles & Guides</h2>
              <div class="search-results__grid">
                {searchResults.content.map((result) => (
                  <a href={result.url} class="result-card" data-search-id={searchResults.searchId}>
                    <span class="result-card__type">{result.pageType || 'Article'}</span>
                    <h3 class="result-card__title">{result.title}</h3>
                    <p class="result-card__description">
                      {result.description.slice(0, 150)}{result.description.length > 150 ? '...' : ''}
                    </p>
                    <span class="result-card__link">Read more ‚Üí</span>
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Product Results -->
          {searchResults.products.length > 0 && (
            <div class="search-results__section">
              <h2 class="search-results__section-title">Recommended Products</h2>
              <div class="search-results__grid search-results__grid--products">
                {searchResults.products.map((result) => (
                  <a href={result.url} class="product-card" data-search-id={searchResults.searchId}>
                    {result.imageUrl && (
                      <img
                        src={result.imageUrl}
                        alt={result.title}
                        class="product-card__image"
                        loading="lazy"
                      />
                    )}
                    <div class="product-card__content">
                      <h3 class="product-card__title">{result.title}</h3>
                      <p class="product-card__description">
                        {result.description.slice(0, 100)}{result.description.length > 100 ? '...' : ''}
                      </p>
                      <span class="product-card__link">View Product ‚Üí</span>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Feedback -->
          <SearchFeedback searchId={searchResults.searchId} query={query} />
        </section>
      )}

      <!-- No Results -->
      {searchResults && searchResults.totalCount === 0 && (
        <section class="search-empty">
          <div class="search-empty__icon">üîç</div>
          <h2 class="search-empty__title">No results found</h2>
          <p class="search-empty__text">
            We couldn't find anything matching "{query}". Try different keywords or browse our popular topics.
          </p>
          <div class="search-empty__suggestions">
            <a href="/search?q=gut%20health" class="search-empty__suggestion">Gut Health</a>
            <a href="/search?q=sick%20chickens" class="search-empty__suggestion">Sick Chickens</a>
            <a href="/search?q=FCR%20improvement" class="search-empty__suggestion">FCR Improvement</a>
            <a href="/search?q=lawn%20care" class="search-empty__suggestion">Lawn Care</a>
          </div>
        </section>
      )}

      <!-- Initial State -->
      {!query && (
        <section class="search-initial">
          <div class="search-initial__examples">
            <h2 class="search-initial__heading">Try searching for:</h2>
            <div class="search-initial__grid">
              <a href="/search?q=my%20chickens%20have%20runny%20poop" class="example-card">
                <span class="example-card__icon">üêî</span>
                <span class="example-card__text">"My chickens have runny poop"</span>
              </a>
              <a href="/search?q=improve%20feed%20conversion%20ratio" class="example-card">
                <span class="example-card__icon">üìä</span>
                <span class="example-card__text">"Improve feed conversion ratio"</span>
              </a>
              <a href="/search?q=reduce%20flock%20mortality" class="example-card">
                <span class="example-card__icon">üí™</span>
                <span class="example-card__text">"Reduce flock mortality"</span>
              </a>
              <a href="/search?q=natural%20lawn%20fertilizer" class="example-card">
                <span class="example-card__icon">üå±</span>
                <span class="example-card__text">"Natural lawn fertilizer"</span>
              </a>
            </div>
          </div>
        </section>
      )}
    </div>
  </main>
</BaseLayout>

<style>
  .search-page {
    min-height: 60vh;
    padding: 40px 20px 80px;
    background: #fafafa;
  }

  .search-page__container {
    max-width: 900px;
    margin: 0 auto;
  }

  .search-page__header {
    text-align: center;
    margin-bottom: 40px;
  }

  .search-page__title {
    font-family: var(--font-heading, 'Eveleth Dot', serif);
    font-size: clamp(24px, 5vw, 36px);
    color: var(--color-title, #2c5234);
    margin-bottom: 24px;
  }

  .search-page__search-bar {
    display: flex;
    justify-content: center;
  }

  /* Results */
  .search-results__count {
    color: #6b7280;
    margin-bottom: 24px;
  }

  .search-results__section {
    margin-bottom: 40px;
  }

  .search-results__section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--color-title, #2c5234);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
  }

  .search-results__grid {
    display: grid;
    gap: 16px;
  }

  .search-results__grid--products {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }

  /* Result Card */
  .result-card {
    display: block;
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-decoration: none;
    border: 1px solid #e5e7eb;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .result-card:hover {
    border-color: var(--color-accent, #44883e);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .result-card__type {
    display: inline-block;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-accent, #44883e);
    margin-bottom: 8px;
  }

  .result-card__title {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
  }

  .result-card__description {
    font-size: 14px;
    color: #6b7280;
    line-height: 1.5;
    margin-bottom: 12px;
  }

  .result-card__link {
    font-size: 14px;
    font-weight: 500;
    color: var(--color-accent, #44883e);
  }

  /* Product Card */
  .product-card {
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    text-decoration: none;
    border: 1px solid #e5e7eb;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .product-card:hover {
    border-color: var(--color-accent, #44883e);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .product-card__image {
    width: 100%;
    height: 160px;
    object-fit: cover;
    background: #f3f4f6;
  }

  .product-card__content {
    padding: 16px;
  }

  .product-card__title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
  }

  .product-card__description {
    font-size: 13px;
    color: #6b7280;
    line-height: 1.4;
    margin-bottom: 12px;
  }

  .product-card__link {
    font-size: 13px;
    font-weight: 500;
    color: var(--color-accent, #44883e);
  }

  /* Empty State */
  .search-empty {
    text-align: center;
    padding: 60px 20px;
  }

  .search-empty__icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  .search-empty__title {
    font-size: 24px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
  }

  .search-empty__text {
    color: #6b7280;
    margin-bottom: 24px;
  }

  .search-empty__suggestions {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }

  .search-empty__suggestion {
    padding: 8px 16px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 9999px;
    color: #4b5563;
    text-decoration: none;
    transition: all 0.2s;
  }

  .search-empty__suggestion:hover {
    background: var(--color-accent, #44883e);
    border-color: var(--color-accent, #44883e);
    color: white;
  }

  /* Initial State */
  .search-initial {
    padding: 40px 0;
  }

  .search-initial__heading {
    font-size: 18px;
    font-weight: 600;
    color: #4b5563;
    margin-bottom: 20px;
    text-align: center;
  }

  .search-initial__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
  }

  .example-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .example-card:hover {
    border-color: var(--color-accent, #44883e);
    background: #f0fdf4;
  }

  .example-card__icon {
    font-size: 24px;
  }

  .example-card__text {
    font-size: 15px;
    color: #374151;
  }
</style>

<script>
  // Track result clicks
  document.querySelectorAll('[data-search-id]').forEach((el) => {
    el.addEventListener('click', () => {
      const searchId = el.getAttribute('data-search-id');
      if (window.pdPixel && searchId) {
        window.pdPixel.track('search_result_clicked', {
          search_id: searchId,
          result_url: (el as HTMLAnchorElement).href,
        });
      }
    });
  });
</script>
