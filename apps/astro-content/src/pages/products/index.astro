---
/**
 * /products/ — Product listing page (SSR)
 *
 * Fetches all products from Shopify Storefront API, renders a grid
 * with client-side search filtering and collection-based filter pills.
 * Persona-aware sorting via CollectionGrid pattern.
 */
import {
  createClient,
  getAllProducts,
  getAllCollections,
} from '@southland/shopify-storefront'
import type { Product } from '@southland/shopify-storefront'
import BaseLayout from '../../layouts/BaseLayout.astro'
import Breadcrumbs from '../../components/shared/Breadcrumbs.astro'
import CollectionProductCard from '../../components/shop/CollectionProductCard.astro'
import type { PersonaId } from '../../lib/persona'

// SSR — do not prerender

// ── Persona ─────────────────────────────────────────────────────────────────
const personaCookie = Astro.cookies.get('sl_persona')?.value ?? null
const validPersonas = ['backyard', 'commercial', 'lawn', 'general']
const persona: PersonaId = personaCookie && validPersonas.includes(personaCookie)
  ? (personaCookie as PersonaId)
  : null

// ── Fetch Shopify data ──────────────────────────────────────────────────────
const client = createClient({
  storeDomain: import.meta.env.PUBLIC_SHOPIFY_STORE_DOMAIN,
  publicAccessToken: import.meta.env.PUBLIC_SHOPIFY_STOREFRONT_TOKEN,
})

const [products, collections] = await Promise.all([
  getAllProducts(client),
  getAllCollections(client),
])

// ── Collection filter pills ──────────────────────────────────────────────────
const skipCollections = new Set(['frontpage', 'all', 'flowers', 'lavender-and-eucalyptus-bundles'])
const filterCollections = collections.filter((c) => !skipCollections.has(c.handle))

// ── SEO ─────────────────────────────────────────────────────────────────────
const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://southlandorganics.com'
const canonicalUrl = `${siteUrl}/products/`

const schema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'All Products',
  description: 'Browse all products from Southland Organics.',
  url: canonicalUrl,
  mainEntity: {
    '@type': 'ItemList',
    numberOfItems: products.length,
    itemListElement: products.slice(0, 50).map((product, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      url: `${siteUrl}/products/${product.handle}/`,
      name: product.title,
    })),
  },
}

const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Products', href: '/products/' },
]
---

<BaseLayout
  title="All Products | Southland Organics"
  description="Browse all organic products from Southland Organics. Poultry supplements, lawn care, garden products, and more."
  canonicalUrl={canonicalUrl}
  schema={schema}
>
  {/* Breadcrumbs */}
  <div class="bg-gray-50 px-4 py-3">
    <div class="mx-auto max-w-6xl">
      <Breadcrumbs items={breadcrumbItems} />
    </div>
  </div>

  {/* Hero */}
  <section class="bg-gradient-to-br from-brand-green-dark to-green-900 px-4 py-12 sm:py-16">
    <div class="mx-auto max-w-6xl text-center">
      <h1 class="font-heading text-3xl text-white sm:text-4xl lg:text-5xl">
        All Products
      </h1>
      <p class="mx-auto mt-4 max-w-2xl text-base text-green-200 sm:text-lg">
        {products.length} scientifically-proven organic products for poultry, lawn, garden, and more.
      </p>
    </div>
  </section>

  {/* Search + filters + grid */}
  <section class="mx-auto max-w-6xl px-4 py-8 sm:py-12">
    {/* Search bar */}
    <div class="mb-6">
      <div class="relative">
        <svg
          class="absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="search"
          id="product-search"
          placeholder="Search products..."
          class="w-full rounded-lg border border-gray-300 py-3 pl-10 pr-4 text-sm text-gray-900 placeholder-gray-400 focus:border-brand-green-light focus:outline-none focus:ring-1 focus:ring-brand-green-light"
        />
      </div>
    </div>

    {/* Collection filter pills */}
    {filterCollections.length > 0 && (
      <div class="mb-6 flex flex-wrap gap-2">
        <button
          type="button"
          data-filter="all"
          class="filter-pill active rounded-full border border-brand-green-dark bg-brand-green-dark px-4 py-1.5 text-sm font-medium text-white transition-colors"
        >
          All
        </button>
        {filterCollections.map((collection) => (
          <a
            href={`/collections/${collection.handle}/`}
            class="rounded-full border border-gray-300 bg-white px-4 py-1.5 text-sm font-medium text-gray-700 transition-colors hover:border-brand-green-light hover:text-brand-green-dark"
          >
            {collection.title}
          </a>
        ))}
      </div>
    )}

    {/* Product count */}
    <p id="product-count" class="mb-4 text-sm text-gray-500">
      Showing {products.length} products
    </p>

    {/* Product grid */}
    <div id="product-grid" class="grid grid-cols-2 gap-4 sm:gap-6 md:grid-cols-3 lg:grid-cols-4">
      {products.map((product) => (
        <div class="product-item" data-title={product.title.toLowerCase()} data-tags={product.tags.join(',').toLowerCase()}>
          <CollectionProductCard product={product} persona={persona} />
        </div>
      ))}
    </div>

    {/* No results (hidden by default) */}
    <div id="no-results" class="hidden py-16 text-center">
      <p class="text-lg text-gray-500">No products match your search.</p>
      <button
        type="button"
        id="clear-search"
        class="mt-3 text-sm font-medium text-brand-green-light hover:underline"
      >
        Clear search
      </button>
    </div>
  </section>
</BaseLayout>

{/* Client-side search filtering */}
<script>
  const searchInput = document.getElementById('product-search') as HTMLInputElement
  const grid = document.getElementById('product-grid')!
  const countEl = document.getElementById('product-count')!
  const noResults = document.getElementById('no-results')!
  const clearBtn = document.getElementById('clear-search')
  const items = grid.querySelectorAll<HTMLElement>('.product-item')
  const total = items.length

  function filterProducts() {
    const query = searchInput.value.toLowerCase().trim()
    let visible = 0

    items.forEach((item) => {
      const title = item.dataset.title || ''
      const tags = item.dataset.tags || ''
      const matches = !query || title.includes(query) || tags.includes(query)

      item.style.display = matches ? '' : 'none'
      if (matches) visible++
    })

    countEl.textContent = query
      ? `Showing ${visible} of ${total} products`
      : `Showing ${total} products`

    grid.classList.toggle('hidden', visible === 0)
    noResults.classList.toggle('hidden', visible > 0)
  }

  searchInput.addEventListener('input', filterProducts)

  clearBtn?.addEventListener('click', () => {
    searchInput.value = ''
    filterProducts()
    searchInput.focus()
  })
</script>
