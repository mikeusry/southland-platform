---
/**
 * /products/[handle] — Product Detail Page (SSR)
 *
 * Fetches product from Shopify Storefront API by handle.
 * Renders full PDP with image gallery, variant selector, add-to-cart,
 * and HTML description. Persona-aware for CTA adaptation.
 */
import {
  createClient,
  getProductByHandle,
  getCollectionProducts,
} from '@southland/shopify-storefront'
import type { Product } from '@southland/shopify-storefront'
import BaseLayout from '../../layouts/BaseLayout.astro'
import Breadcrumbs from '../../components/shared/Breadcrumbs.astro'
import ImageGallery from '../../components/product/ImageGallery'
import AddToCartButton from '../../components/product/AddToCartButton'
import CollectionProductCard from '../../components/shop/CollectionProductCard.astro'
import type { PersonaId } from '../../lib/persona'

// SSR — do not prerender
const { handle } = Astro.params

if (!handle) {
  return Astro.redirect('/collections/')
}

// ── Read persona from cookie (server-side) ──────────────────────────────────
const personaCookie = Astro.cookies.get('sl_persona')?.value ?? null
const validPersonas = ['backyard', 'commercial', 'lawn', 'general']
const persona: PersonaId =
  personaCookie && validPersonas.includes(personaCookie) ? (personaCookie as PersonaId) : null

// ── Fetch product from Shopify ──────────────────────────────────────────────
const client = createClient({
  storeDomain: import.meta.env.PUBLIC_SHOPIFY_STORE_DOMAIN,
  publicAccessToken: import.meta.env.PUBLIC_SHOPIFY_STOREFRONT_TOKEN,
})

const product = await getProductByHandle(client, handle)

if (!product) {
  return Astro.redirect('/collections/')
}

// ── Related products (same productType collection) ──────────────────────────
let relatedProducts: Product[] = []
if (product.productType) {
  const typeHandle = product.productType.toLowerCase().replace(/\s+/g, '-')
  const collection = await getCollectionProducts(client, typeHandle, 8)
  if (collection) {
    relatedProducts = collection.products.filter((p) => p.handle !== handle).slice(0, 4)
  }
}

// ── SEO metadata ────────────────────────────────────────────────────────────
const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://southlandorganics.com'
const canonicalUrl = `${siteUrl}/products/${handle}/`

const pageTitle = product.seo.title || `${product.title} | Southland Organics`
const pageDescription =
  product.seo.description || product.description.slice(0, 160).replace(/\s+/g, ' ').trim()

const ogImage = product.images[0]?.url ?? '/images/podcast/og-default.jpg'

// ── Schema.org Product ──────────────────────────────────────────────────────
const productSchema = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: product.title,
  description: product.description,
  url: canonicalUrl,
  image: product.images.map((img) => img.url),
  brand: {
    '@type': 'Brand',
    name: product.vendor || 'Southland Organics',
  },
  offers: product.variants.map((variant) => ({
    '@type': 'Offer',
    name: variant.title !== 'Default Title' ? variant.title : product.title,
    price: variant.price.amount,
    priceCurrency: variant.price.currencyCode || 'USD',
    availability: variant.availableForSale
      ? 'https://schema.org/InStock'
      : 'https://schema.org/OutOfStock',
    url: canonicalUrl,
  })),
}

// ── Breadcrumb items ────────────────────────────────────────────────────────
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Collections', href: '/collections/' },
  { label: product.title, href: `/products/${handle}/` },
]

// ── Price display for static rendering ──────────────────────────────────────
const minPrice = product.priceRange.minVariantPrice
const priceFormatted = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: minPrice.currencyCode || 'USD',
}).format(Number(minPrice.amount))

const hasMultipleVariants = product.variants.length > 1
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  ogImage={ogImage}
  canonicalUrl={canonicalUrl}
  schema={productSchema}
>
  {/* Breadcrumbs */}
  <div class="bg-gray-50 px-4 py-3">
    <div class="mx-auto max-w-6xl">
      <Breadcrumbs items={breadcrumbItems} />
    </div>
  </div>

  {/* Product hero section */}
  <section class="mx-auto max-w-6xl px-4 py-8 sm:py-12">
    <div class="grid gap-8 md:grid-cols-2 md:gap-12">
      {/* Left: Image gallery */}
      <div>
        <ImageGallery client:load images={product.images} productTitle={product.title} />
      </div>

      {/* Right: Product info + add to cart */}
      <div class="flex flex-col">
        {/* Vendor badge */}
        {
          product.vendor && product.vendor !== 'Southland Organics' && (
            <span class="mb-2 text-sm font-medium uppercase tracking-wider text-gray-500">
              {product.vendor}
            </span>
          )
        }

        <h1 class="font-heading text-3xl text-gray-900 sm:text-4xl">
          {product.title}
        </h1>

        {/* Product type tag */}
        {
          product.productType && (
            <a
              href={`/collections/${product.productType.toLowerCase().replace(/\s+/g, '-')}/`}
              class="text-brand-green-light mt-2 inline-block text-sm hover:underline"
            >
              {product.productType}
            </a>
          )
        }

        {/* Price (shown in static HTML, also in AddToCartButton for selected variant) */}
        {
          !hasMultipleVariants && (
            <p class="mt-4 text-2xl font-bold text-gray-900">{priceFormatted}</p>
          )
        }
        {hasMultipleVariants && <p class="mt-4 text-sm text-gray-500">From {priceFormatted}</p>}

        {/* Add to cart island */}
        <div class="mt-6">
          <AddToCartButton client:load variants={product.variants} />
        </div>

        {/* Short description (plain text) */}
        {
          product.description && (
            <p class="mt-6 text-sm leading-relaxed text-gray-600">
              {product.description.length > 300
                ? product.description.slice(0, 300).trim() + '...'
                : product.description}
            </p>
          )
        }

        {/* Tags */}
        {
          product.tags.length > 0 && (
            <div class="mt-6 flex flex-wrap gap-2">
              {product.tags.map((tag) => (
                <span class="rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-600">
                  {tag}
                </span>
              ))}
            </div>
          )
        }
      </div>
    </div>
  </section>

  {/* Full HTML description */}
  {
    product.descriptionHtml && product.descriptionHtml !== '<p></p>' && (
      <section class="border-t border-gray-100">
        <div class="mx-auto max-w-3xl px-4 py-8 sm:py-12">
          <h2 class="font-heading text-2xl text-gray-900">Product Details</h2>
          <div
            class="prose prose-sm prose-headings:font-heading prose-a:text-brand-green-light mt-4 max-w-none"
            set:html={product.descriptionHtml}
          />
        </div>
      </section>
    )
  }

  {/* Related products */}
  {
    relatedProducts.length > 0 && (
      <section class="border-t border-gray-100 bg-gray-50">
        <div class="mx-auto max-w-6xl px-4 py-8 sm:py-12">
          <h2 class="font-heading text-2xl text-gray-900">Related Products</h2>
          <div class="mt-6 grid grid-cols-2 gap-4 sm:gap-6 md:grid-cols-4">
            {relatedProducts.map((related) => (
              <CollectionProductCard product={related} persona={persona} />
            ))}
          </div>
        </div>
      </section>
    )
  }
</BaseLayout>
