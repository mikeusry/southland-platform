---
/**
 * Store Locator Page - /store-locator/
 * Find Southland Organics dealers and retailers near you
 *
 * Dealer data loaded from src/data/dealers.json (generated by scripts/import-dealers.mjs).
 * Map powered by Google Maps JavaScript API with Places Autocomplete.
 */

export const prerender = true

import BaseLayout from '../../layouts/BaseLayout.astro'
import { getLogoUrl } from '../../lib/cloudinary'
import dealersData from '../../data/dealers.json'

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://southlandorganics.com'
const mapsApiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY

// Filter active dealers at build time
const dealers = dealersData.filter((d: any) => d.active !== false)

// Build unique categories from data
const allCategories = [...new Set(dealers.flatMap((d: any) => d.categories || []))].sort()

const storeLocatorSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebPage',
  name: 'Store Locator | Southland Organics',
  description:
    'Find Southland Organics products near you. Locate authorized dealers and retailers for poultry, turf, and lawn & garden products.',
  url: `${siteUrl}/store-locator/`,
}
---

<BaseLayout
  title="Store Locator | Find Southland Organics Near You"
  description="Find Southland Organics products near you. Locate authorized dealers and retailers for poultry, turf, and lawn & garden products."
  ogImage={getLogoUrl('square', { width: 800 })}
  schema={storeLocatorSchema}
>
  <!-- Hero -->
  <section class="bg-southland-green-dark py-12 md:py-16">
    <div class="mx-auto max-w-7xl px-4 text-center sm:px-6 lg:px-8">
      <h1 class="mb-4 font-heading text-4xl text-white md:text-5xl">Find a Dealer</h1>
      <p class="mx-auto max-w-2xl text-lg text-white/80">
        Locate authorized Southland Organics dealers near you. Can't find one in your area? Order
        direct or
        <a href="/contact/" class="font-semibold text-southland-green underline hover:text-white"
          >contact us</a
        > about becoming a dealer.
      </p>
    </div>
  </section>

  <!-- Search + Results -->
  <section class="bg-brand-gray py-8 md:py-12">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <!-- Search Bar -->
      <div class="mb-8 rounded-2xl bg-white p-6 shadow-sm">
        <div class="flex flex-col gap-4 md:flex-row md:items-end">
          <div class="flex-1">
            <label for="location-search" class="mb-1.5 block text-sm font-medium text-shopify-title"
              >Search by city, state, or zip code</label
            >
            <div class="relative">
              <svg
                class="absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <input
                type="text"
                id="location-search"
                placeholder="e.g., Atlanta, GA or 30301"
                class="w-full rounded-lg border border-gray-300 py-3 pl-10 pr-4 text-shopify-title transition-colors focus:border-southland-green focus:outline-none focus:ring-2 focus:ring-southland-green/20"
              />
            </div>
          </div>
          <div>
            <label for="category-filter" class="mb-1.5 block text-sm font-medium text-shopify-title"
              >Product Category</label
            >
            <select
              id="category-filter"
              class="w-full rounded-lg border border-gray-300 px-4 py-3 text-shopify-title transition-colors focus:border-southland-green focus:outline-none focus:ring-2 focus:ring-southland-green/20 md:w-auto"
            >
              <option value="all">All Products</option>
              {
                allCategories.map((cat: string) => (
                  <option value={cat}>
                    {cat.charAt(0).toUpperCase() + cat.slice(1).replace('-', ' & ')}
                  </option>
                ))
              }
            </select>
          </div>
          <button
            id="use-location-btn"
            class="inline-flex items-center justify-center gap-2 rounded-lg border-2 border-southland-green px-5 py-3 font-bold text-southland-green transition-all hover:bg-southland-green hover:text-white active:scale-[0.98]"
            title="Use my current location"
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"
              ></path>
            </svg>
            <span class="hidden sm:inline">Near Me</span>
          </button>
          <button
            id="search-btn"
            class="inline-flex items-center justify-center gap-2 rounded-lg bg-southland-green px-6 py-3 font-bold text-white transition-all hover:bg-[#3a7534] active:scale-[0.98]"
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            Search
          </button>
        </div>
      </div>

      <!-- Results Grid -->
      <div class="grid gap-8 lg:grid-cols-5">
        <!-- Dealer List -->
        <div class="space-y-[5px] lg:col-span-2 lg:max-h-[600px] lg:overflow-y-auto lg:pr-2">
          <div id="dealer-count" class="text-sm font-medium text-shopify-secondary-text">
            Loading dealers...
          </div>
          <div id="dealer-list">
            <!-- Populated by JS -->
          </div>
          <div id="no-results" class="hidden py-12 text-center">
            <svg
              class="mx-auto mb-4 h-12 w-12 text-gray-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <p class="mb-2 font-bold text-shopify-title">No dealers found in that area</p>
            <p class="text-sm text-shopify-secondary-text">
              Try a different location, or
              <a
                href="https://www.southlandorganics.com"
                class="text-southland-green hover:underline">order direct</a
              > from our website.
            </p>
          </div>
        </div>

        <!-- Map -->
        <div class="lg:col-span-3">
          <div
            id="map-container"
            class="overflow-hidden rounded-2xl bg-gray-200 shadow-sm"
            style="min-height: 500px;"
          >
            <div id="dealer-map" style="width: 100%; height: 500px;"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Become a Dealer CTA -->
  <section class="bg-white py-16">
    <div class="mx-auto max-w-4xl px-4 text-center sm:px-6 lg:px-8">
      <h2 class="mb-4 text-3xl font-bold text-shopify-title">Want to Carry Our Products?</h2>
      <p class="mx-auto mb-8 max-w-2xl text-lg text-shopify-secondary-text">
        Join our growing network of authorized dealers. We provide training, marketing support, and
        competitive wholesale pricing.
      </p>
      <div class="flex flex-col items-center justify-center gap-4 sm:flex-row">
        <a
          href="/distribution/"
          class="inline-flex items-center justify-center gap-2 rounded-lg bg-southland-green px-8 py-4 text-base font-bold text-white shadow-sm transition-all hover:bg-[#3a7534] hover:shadow-md active:scale-[0.98]"
        >
          Learn About Our Dealer Program
        </a>
        <a
          href="/contact/"
          class="inline-flex items-center justify-center gap-2 rounded-lg border-2 border-gray-300 px-8 py-4 text-base font-bold text-shopify-title transition-all hover:border-southland-green hover:text-southland-green"
        >
          Contact Us
        </a>
      </div>
    </div>
  </section>

  <!-- Order Direct Callout -->
  <section class="bg-brand-gray py-12">
    <div class="mx-auto max-w-4xl px-4 text-center sm:px-6 lg:px-8">
      <p class="mb-2 text-sm font-semibold uppercase tracking-wide text-southland-green">
        No dealer nearby?
      </p>
      <h3 class="mb-4 text-2xl font-bold text-shopify-title">Order Direct — We Ship Nationwide</h3>
      <p class="mx-auto mb-6 max-w-xl text-shopify-secondary-text">
        All Southland Organics products are available for direct purchase online with UPS shipping
        across the United States.
      </p>
      <a
        href="https://www.southlandorganics.com"
        class="inline-flex items-center gap-2 font-bold text-southland-green hover:underline"
      >
        Shop Online
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
      </a>
    </div>
  </section>

  <!-- Inject dealer data as JSON for client JS -->
  <script is:inline type="application/json" id="dealer-data" set:html={JSON.stringify(dealers)} />
</BaseLayout>

<!-- Google Maps JS API with Places library -->
<script
  is:inline
  src={`https://maps.googleapis.com/maps/api/js?key=${mapsApiKey}&libraries=places&callback=initStoreLocator`}
  async
  defer></script>

<script is:inline>
  // ─── Globals ───────────────────────────────────────────────
  var map,
    geocoder,
    markers = [],
    infoWindow,
    searchOrigin = null

  // ─── Haversine distance (miles) ────────────────────────────
  function haversine(lat1, lng1, lat2, lng2) {
    var R = 3959 // Earth radius in miles
    var dLat = ((lat2 - lat1) * Math.PI) / 180
    var dLng = ((lng2 - lng1) * Math.PI) / 180
    var a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLng / 2) *
        Math.sin(dLng / 2)
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
  }

  // ─── Badge config ──────────────────────────────────────────
  var BADGE_CONFIG = {
    headquarters: { label: 'HQ', bg: 'bg-southland-green/10', text: 'text-southland-green' },
    farm_store: { label: 'Farm Store', bg: 'bg-blue-50', text: 'text-blue-700' },
    dealer: { label: 'Dealer', bg: 'bg-orange-50', text: 'text-orange-700' },
    distributor: { label: 'Distributor', bg: 'bg-purple-50', text: 'text-purple-700' },
  }

  // ─── Marker icons ──────────────────────────────────────────
  function getMarkerIcon(dealerType) {
    var colors = {
      headquarters: '#2C5234',
      farm_store: '#2563eb',
      dealer: '#ea580c',
      distributor: '#7c3aed',
    }
    var color = colors[dealerType] || '#6b7280'
    return {
      path: 'M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z',
      fillColor: color,
      fillOpacity: 1,
      strokeColor: '#ffffff',
      strokeWeight: 2,
      scale: 1.5,
      anchor: new google.maps.Point(12, 22),
    }
  }

  // ─── Load dealer data ──────────────────────────────────────
  function getDealers() {
    try {
      return JSON.parse(document.getElementById('dealer-data').textContent)
    } catch (e) {
      console.error('Failed to parse dealer data:', e)
      return []
    }
  }

  // ─── Format address for display ────────────────────────────
  function formatAddress(d) {
    var parts = [d.address, d.city, d.state].filter(Boolean)
    var line = parts.join(', ')
    if (d.zip) line += ' ' + d.zip
    return line
  }

  // ─── Render dealer cards ───────────────────────────────────
  function renderDealers(filteredDealers) {
    var dealerList = document.getElementById('dealer-list')
    var dealerCount = document.getElementById('dealer-count')
    var noResults = document.getElementById('no-results')
    if (!dealerList || !dealerCount || !noResults) return

    if (filteredDealers.length === 0) {
      dealerList.innerHTML = ''
      noResults.classList.remove('hidden')
      dealerCount.textContent = 'No dealers found'
      return
    }

    noResults.classList.add('hidden')
    var countText =
      'Showing ' + filteredDealers.length + ' location' + (filteredDealers.length !== 1 ? 's' : '')
    if (searchOrigin) countText += ' (sorted by distance)'
    dealerCount.textContent = countText

    dealerList.innerHTML = filteredDealers
      .map(function (dealer) {
        var badge = BADGE_CONFIG[dealer.dealerType] || BADGE_CONFIG.dealer
        var addr = formatAddress(dealer)
        var distHtml =
          dealer._distance != null
            ? '<span class="text-xs text-shopify-secondary-text">' +
              dealer._distance.toFixed(1) +
              ' mi</span>'
            : ''

        var phoneHtml = dealer.phone
          ? '<a href="tel:' +
            dealer.phone.replace(/[^+\d]/g, '') +
            '" class="mt-2 inline-flex items-center gap-1.5 text-sm font-medium text-southland-green hover:underline">' +
            '<svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>' +
            dealer.phone +
            '</a>'
          : ''

        var catHtml = (dealer.categories || [])
          .map(function (cat) {
            return (
              '<span class="rounded-full bg-gray-100 px-2.5 py-0.5 text-xs text-gray-600">' +
              cat +
              '</span>'
            )
          })
          .join('')

        return (
          '<div class="dealer-card rounded-xl bg-white p-5 shadow-sm border border-gray-100 hover:border-southland-green/30 transition-colors cursor-pointer" data-lat="' +
          dealer.lat +
          '" data-lng="' +
          dealer.lng +
          '" data-slug="' +
          dealer.slug +
          '">' +
          '<div class="flex items-start justify-between gap-3">' +
          '<div class="min-w-0">' +
          '<h3 class="font-bold text-shopify-title text-sm">' +
          dealer.name +
          '</h3>' +
          '<p class="mt-1 text-sm text-shopify-secondary-text">' +
          addr +
          '</p>' +
          phoneHtml +
          '</div>' +
          '<div class="flex shrink-0 flex-col items-end gap-1">' +
          '<span class="rounded-full px-2.5 py-0.5 text-xs font-medium ' +
          badge.bg +
          ' ' +
          badge.text +
          '">' +
          badge.label +
          '</span>' +
          catHtml +
          distHtml +
          '</div>' +
          '</div>' +
          '<a href="https://www.google.com/maps/dir/?api=1&destination=' +
          encodeURIComponent(addr) +
          '" target="_blank" rel="noopener noreferrer" class="mt-3 inline-flex items-center gap-1.5 text-sm font-medium text-southland-green hover:underline">' +
          'Get Directions' +
          '<svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>' +
          '</a>' +
          '</div>'
        )
      })
      .join('')

    // Click handler: pan map to dealer + open info window
    dealerList.querySelectorAll('.dealer-card').forEach(function (card) {
      card.addEventListener('click', function (e) {
        if (e.target.closest('a')) return // Don't hijack link clicks
        var lat = parseFloat(card.dataset.lat)
        var lng = parseFloat(card.dataset.lng)
        var slug = card.dataset.slug
        map.panTo({ lat: lat, lng: lng })
        map.setZoom(13)
        // Open matching marker's info window
        var marker = markers.find(function (m) {
          return m._slug === slug
        })
        if (marker) google.maps.event.trigger(marker, 'click')
      })
    })
  }

  // ─── Update map markers ────────────────────────────────────
  function updateMarkers(filteredDealers) {
    // Clear existing markers
    markers.forEach(function (m) {
      m.setMap(null)
    })
    markers = []

    var bounds = new google.maps.LatLngBounds()

    filteredDealers.forEach(function (dealer) {
      if (!dealer.lat || !dealer.lng) return
      var pos = { lat: dealer.lat, lng: dealer.lng }
      var marker = new google.maps.Marker({
        position: pos,
        map: map,
        title: dealer.name,
        icon: getMarkerIcon(dealer.dealerType),
      })
      marker._slug = dealer.slug

      var addr = formatAddress(dealer)
      var distLine =
        dealer._distance != null
          ? '<p style="margin:4px 0 0;font-size:12px;color:#686363;">' +
            dealer._distance.toFixed(1) +
            ' miles away</p>'
          : ''
      var phoneLine = dealer.phone
        ? '<p style="margin:4px 0 0;"><a href="tel:' +
          dealer.phone.replace(/[^+\d]/g, '') +
          '" style="color:#44883E;text-decoration:none;">' +
          dealer.phone +
          '</a></p>'
        : ''
      var content =
        '<div style="max-width:260px;font-family:Open Sans,sans-serif;">' +
        '<h3 style="margin:0 0 4px;font-size:14px;font-weight:700;color:#191D21;">' +
        dealer.name +
        '</h3>' +
        '<p style="margin:0;font-size:13px;color:#686363;">' +
        addr +
        '</p>' +
        phoneLine +
        distLine +
        '<a href="https://www.google.com/maps/dir/?api=1&destination=' +
        encodeURIComponent(addr) +
        '" target="_blank" rel="noopener noreferrer" style="display:inline-block;margin-top:8px;font-size:13px;font-weight:600;color:#44883E;text-decoration:none;">Get Directions &rarr;</a>' +
        '</div>'

      marker.addListener('click', function () {
        infoWindow.setContent(content)
        infoWindow.open(map, marker)
      })

      markers.push(marker)
      bounds.extend(pos)
    })

    // Add search origin marker if we have one
    if (searchOrigin) {
      bounds.extend(searchOrigin)
    }

    if (filteredDealers.length > 0) {
      map.fitBounds(bounds, { padding: 50 })
      // Don't zoom in too far if only 1-2 results
      var listener = google.maps.event.addListener(map, 'idle', function () {
        if (map.getZoom() > 12) map.setZoom(12)
        google.maps.event.removeListener(listener)
      })
    }
  }

  // ─── Filter + sort dealers ─────────────────────────────────
  function filterAndDisplay() {
    var dealers = getDealers()
    var category = document.getElementById('category-filter').value

    // Category filter
    if (category !== 'all') {
      dealers = dealers.filter(function (d) {
        return d.categories && d.categories.indexOf(category) !== -1
      })
    }

    // If we have a search origin, compute distances and sort
    if (searchOrigin) {
      dealers.forEach(function (d) {
        d._distance = haversine(searchOrigin.lat, searchOrigin.lng, d.lat, d.lng)
      })
      dealers.sort(function (a, b) {
        return a._distance - b._distance
      })
      // Show only dealers within 200 miles, or at least 10
      var nearby = dealers.filter(function (d) {
        return d._distance <= 200
      })
      if (nearby.length < 10) nearby = dealers.slice(0, 10)
      dealers = nearby
    }

    renderDealers(dealers)
    updateMarkers(dealers)
  }

  // ─── Geocode search input ──────────────────────────────────
  function searchByText() {
    var query = document.getElementById('location-search').value.trim()
    if (!query) {
      searchOrigin = null
      filterAndDisplay()
      return
    }

    geocoder.geocode(
      { address: query, componentRestrictions: { country: 'US' } },
      function (results, status) {
        if (status === 'OK' && results[0]) {
          var loc = results[0].geometry.location
          searchOrigin = { lat: loc.lat(), lng: loc.lng() }
        } else {
          searchOrigin = null
        }
        filterAndDisplay()
      }
    )
  }

  // ─── Use my location ──────────────────────────────────────
  function useMyLocation() {
    var btn = document.getElementById('use-location-btn')
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser.')
      return
    }
    btn.disabled = true
    btn.querySelector('span')?.replaceWith(document.createTextNode('Locating...'))

    navigator.geolocation.getCurrentPosition(
      function (pos) {
        searchOrigin = { lat: pos.coords.latitude, lng: pos.coords.longitude }
        document.getElementById('location-search').value = 'My Location'
        filterAndDisplay()
        btn.disabled = false
        var span = document.createElement('span')
        span.className = 'hidden sm:inline'
        span.textContent = 'Near Me'
        btn.querySelector('svg').insertAdjacentElement('afterend', span)
      },
      function (err) {
        alert('Unable to get your location. Please search by city or zip code instead.')
        btn.disabled = false
        var span = document.createElement('span')
        span.className = 'hidden sm:inline'
        span.textContent = 'Near Me'
        btn.querySelector('svg').insertAdjacentElement('afterend', span)
      },
      { enableHighAccuracy: false, timeout: 10000 }
    )
  }

  // ─── Init (called by Google Maps callback) ─────────────────
  window.initStoreLocator = function () {
    // Initialize map
    map = new google.maps.Map(document.getElementById('dealer-map'), {
      center: { lat: 35, lng: -90 },
      zoom: 4,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true,
      styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }],
    })
    geocoder = new google.maps.Geocoder()
    infoWindow = new google.maps.InfoWindow()

    // Places Autocomplete on search input
    var input = document.getElementById('location-search')
    var autocomplete = new google.maps.places.Autocomplete(input, {
      types: ['geocode'],
      componentRestrictions: { country: 'us' },
    })
    autocomplete.addListener('place_changed', function () {
      var place = autocomplete.getPlace()
      if (place.geometry) {
        searchOrigin = {
          lat: place.geometry.location.lat(),
          lng: place.geometry.location.lng(),
        }
        filterAndDisplay()
      }
    })

    // Event listeners
    document.getElementById('search-btn').addEventListener('click', searchByText)
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault()
        searchByText()
      }
    })
    document.getElementById('category-filter').addEventListener('change', filterAndDisplay)
    document.getElementById('use-location-btn').addEventListener('click', useMyLocation)

    // Initial render — show all dealers
    filterAndDisplay()
  }
</script>
