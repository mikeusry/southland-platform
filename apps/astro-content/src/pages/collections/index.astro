---
/**
 * /collections/ — Collection index page (SSR)
 *
 * Browsable grid of all active Shopify collections.
 * Pulls from TinaCMS content files to get titles and descriptions,
 * falls back to Shopify data for collections without TinaCMS docs.
 */
import { getCollection } from 'astro:content'
import {
  createClient,
  getAllCollections,
} from '@southland/shopify-storefront'
import BaseLayout from '../../layouts/BaseLayout.astro'

// SSR — do not prerender

// ── Fetch TinaCMS collection docs ───────────────────────────────────────────
const tinaDocs = await getCollection('shopCollections')
const tinaByHandle = new Map(
  tinaDocs.map((doc) => [doc.data.handle, doc])
)

// ── Fetch Shopify collections ───────────────────────────────────────────────
const client = createClient({
  storeDomain: import.meta.env.PUBLIC_SHOPIFY_STORE_DOMAIN,
  publicAccessToken: import.meta.env.PUBLIC_SHOPIFY_STOREFRONT_TOKEN,
})

const shopifyCollections = await getAllCollections(client)

// ── Merge and filter ────────────────────────────────────────────────────────
// Skip empty/legacy collections
const skipHandles = new Set(['lavender-and-eucalyptus-bundles', 'flowers'])

const collections = shopifyCollections
  .filter((c) => !skipHandles.has(c.handle))
  .map((c) => {
    const tina = tinaByHandle.get(c.handle)
    return {
      handle: c.handle,
      title: tina?.data.title || c.title,
      description: tina?.data.seoDescription || c.description || '',
      image: c.image,
      persona: tina?.data.persona ?? null,
    }
  })

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://southlandorganics.com'

const schema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'Shop Collections',
  description: 'Browse all product collections from Southland Organics.',
  url: `${siteUrl}/collections/`,
}

// Persona color accents for collection cards
const personaAccent: Record<string, string> = {
  backyard: 'border-l-amber-500',
  commercial: 'border-l-green-600',
  lawn: 'border-l-emerald-500',
}
---

<BaseLayout
  title="Shop Collections | Southland Organics"
  description="Browse all product collections from Southland Organics. Organic poultry supplements, lawn care, garden products, and more."
  canonicalUrl={`${siteUrl}/collections/`}
  schema={schema}
>
  {/* Breadcrumbs */}
  <nav class="bg-gray-50 px-4 py-3" aria-label="Breadcrumb">
    <ol class="mx-auto flex max-w-6xl items-center gap-2 text-sm text-gray-500">
      <li><a href="/" class="hover:text-brand-green-light">Home</a></li>
      <li class="text-gray-300">/</li>
      <li class="font-medium text-gray-900">Collections</li>
    </ol>
  </nav>

  {/* Hero */}
  <section class="bg-gradient-to-br from-brand-green-dark to-green-900 px-4 py-12 sm:py-16">
    <div class="mx-auto max-w-6xl text-center">
      <h1 class="font-heading text-3xl text-white sm:text-4xl lg:text-5xl">
        Shop Collections
      </h1>
      <p class="mx-auto mt-4 max-w-2xl text-base text-green-200 sm:text-lg">
        Scientifically-proven organic products for poultry, lawn, garden, and more.
      </p>
    </div>
  </section>

  {/* Collection Grid */}
  <section class="mx-auto max-w-6xl px-4 py-8 sm:py-12">
    <div class="grid gap-4 sm:grid-cols-2 sm:gap-6 lg:grid-cols-3">
      {collections.map((collection) => (
        <a
          href={`/collections/${collection.handle}/`}
          class:list={[
            'group block rounded-lg border border-gray-200 bg-white p-5 transition-shadow hover:shadow-md',
            collection.persona ? `border-l-4 ${personaAccent[collection.persona] || ''}` : '',
          ]}
        >
          <h2 class="font-heading text-lg text-brand-green-dark group-hover:text-brand-green-light">
            {collection.title}
          </h2>

          {collection.description && (
            <p class="mt-2 line-clamp-2 text-sm text-gray-600">
              {collection.description}
            </p>
          )}

          <span class="mt-3 inline-block text-sm font-medium text-brand-green-light group-hover:underline">
            Browse Collection &rarr;
          </span>
        </a>
      ))}
    </div>
  </section>
</BaseLayout>
