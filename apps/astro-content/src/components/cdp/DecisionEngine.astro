---
/**
 * Decision Engine Component
 *
 * CDP Week 1 - Homepage 3-way branch
 * Asks visitors "What describes you best?" to route them into persona-specific
 * reality tunnels (Backyard Betty, Broiler Bill, Turf Pro Taylor)
 *
 * Features:
 * - 3 clickable persona cards
 * - Persists selection in localStorage + cookie (cross-subdomain)
 * - Fires `persona_path_selected` event to point.dog pixel
 * - Redirects to persona landing page
 */

interface Props {
  headline?: string;
  subheadline?: string;
  class?: string;
}

const {
  headline = "What best describes you?",
  subheadline = "Help us personalize your experience",
  class: className = '',
} = Astro.props;

// Persona paths configuration
const personaPaths = [
  {
    id: 'backyard',
    label: 'Backyard Flock',
    description: 'Hobby chicken keepers with small flocks at home',
    icon: 'chicken',
    href: '/poultry/backyard/',
    color: 'bg-amber-50 hover:bg-amber-100 border-amber-200',
    iconColor: 'text-amber-600',
  },
  {
    id: 'commercial',
    label: 'Commercial Poultry',
    description: 'Broiler farms, layer operations, or contract growers',
    icon: 'barn',
    href: '/poultry/commercial/',
    color: 'bg-green-50 hover:bg-green-100 border-green-200',
    iconColor: 'text-green-700',
  },
  {
    id: 'lawn',
    label: 'Lawn & Garden',
    description: 'Homeowners, landscapers, or turf professionals',
    icon: 'grass',
    href: '/lawn/',
    color: 'bg-emerald-50 hover:bg-emerald-100 border-emerald-200',
    iconColor: 'text-emerald-600',
  },
];
---

<section class={`decision-engine py-12 ${className}`}>
  <div class="max-w-4xl mx-auto px-4">
    <!-- Header -->
    <div class="text-center mb-10">
      <h2 class="text-3xl md:text-4xl font-bold mb-3" style="color: var(--color-title);">
        {headline}
      </h2>
      <p class="text-lg text-gray-600">
        {subheadline}
      </p>
    </div>

    <!-- Persona Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      {personaPaths.map((persona) => (
        <button
          class={`persona-card group relative p-6 rounded-xl border-2 transition-all duration-300 cursor-pointer text-left ${persona.color}`}
          data-persona-id={persona.id}
          data-persona-href={persona.href}
          aria-label={`Select ${persona.label}`}
        >
          <!-- Icon -->
          <div class={`w-16 h-16 mb-4 rounded-full bg-white shadow-sm flex items-center justify-center ${persona.iconColor}`}>
            {persona.icon === 'chicken' && (
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 19c-4 0-7-2.5-7-6 0-2 1-3.5 2-4.5-.5-1-.5-2.5 0-3.5 1 0 2 .5 2.5 1 .5-1 1.5-2 3-2s2.5 1 3 2c.5-.5 1.5-1 2.5-1 .5 1 .5 2.5 0 3.5 1 1 2 2.5 2 4.5 0 3.5-3 6-7 6z"/>
                <circle cx="9" cy="11" r="1" fill="currentColor"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 13v2"/>
              </svg>
            )}
            {persona.icon === 'barn' && (
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 21h18M4 21V10l8-6 8 6v11M9 21v-6h6v6"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4l-8 6h16l-8-6z"/>
              </svg>
            )}
            {persona.icon === 'grass' && (
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21V8c0-3 3-5 5-5M12 21V8c0-3 3-5 5-5M17 21v-8c0-2-2-4-4-4"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 21c0-3 2-5 4-6M19 21c0-3-2-5-4-6"/>
              </svg>
            )}
          </div>

          <!-- Content -->
          <h3 class="text-xl font-bold mb-2" style="color: var(--color-title);">
            {persona.label}
          </h3>
          <p class="text-gray-600 text-sm leading-relaxed">
            {persona.description}
          </p>

          <!-- Arrow indicator -->
          <div class="absolute right-4 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
            <svg class={`w-6 h-6 ${persona.iconColor}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        </button>
      ))}
    </div>

    <!-- Skip link (for returning visitors or those who don't want personalization) -->
    <div class="text-center mt-8">
      <button
        class="text-sm text-gray-500 hover:text-gray-700 underline underline-offset-2 skip-personalization"
        aria-label="Skip personalization and continue to main site"
      >
        Just browsing? Skip this step
      </button>
    </div>
  </div>
</section>

<script>
  // Decision Engine Client Logic
  const STORAGE_KEY = 'southland_persona';
  const COOKIE_NAME = 'sl_persona';
  const COOKIE_DAYS = 365;

  interface PersonaData {
    id: string;
    selectedAt: string;
    source: 'decision_engine';
  }

  // Utility: Set cookie (cross-subdomain compatible)
  function setCookie(name: string, value: string, days: number): void {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    // Use root domain for cross-subdomain access
    const domain = window.location.hostname.replace(/^www\./, '');
    document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; domain=.${domain}; SameSite=Lax`;
  }

  // Utility: Get cookie
  function getCookie(name: string): string | null {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
      return decodeURIComponent(parts.pop()!.split(';').shift()!);
    }
    return null;
  }

  // Check if persona already selected (for returning visitors)
  function getStoredPersona(): PersonaData | null {
    // Check localStorage first
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      try {
        return JSON.parse(stored);
      } catch {
        // Invalid JSON, clear it
        localStorage.removeItem(STORAGE_KEY);
      }
    }

    // Check cookie fallback
    const cookieVal = getCookie(COOKIE_NAME);
    if (cookieVal) {
      return { id: cookieVal, selectedAt: '', source: 'decision_engine' };
    }

    return null;
  }

  // Store persona selection
  function storePersona(personaId: string): void {
    const data: PersonaData = {
      id: personaId,
      selectedAt: new Date().toISOString(),
      source: 'decision_engine',
    };

    // Store in localStorage
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

    // Store in cookie for cross-subdomain/server access
    setCookie(COOKIE_NAME, personaId, COOKIE_DAYS);
  }

  // Track persona selection via point.dog pixel
  function trackPersonaSelection(personaId: string, href: string): void {
    // point.dog pixel
    if (window.pdPixel) {
      window.pdPixel.track('persona_path_selected', {
        persona_id: personaId,
        persona_label: personaId === 'backyard' ? 'Backyard Flock' :
                       personaId === 'commercial' ? 'Commercial Poultry' : 'Lawn & Garden',
        source: 'decision_engine',
        destination: href,
        page: window.location.pathname,
      });
    }

    // GTM dataLayer
    if (window.dataLayer) {
      window.dataLayer.push({
        event: 'persona_path_selected',
        persona_id: personaId,
        destination: href,
      });
    }
  }

  // Handle card clicks
  document.querySelectorAll('.persona-card').forEach((card) => {
    card.addEventListener('click', (e) => {
      const button = e.currentTarget as HTMLButtonElement;
      const personaId = button.dataset.personaId;
      const href = button.dataset.personaHref;

      if (!personaId || !href) return;

      // Store selection
      storePersona(personaId);

      // Track event
      trackPersonaSelection(personaId, href);

      // Add visual feedback
      button.classList.add('ring-4', 'ring-green-500', 'ring-opacity-50');

      // Navigate after brief delay for visual feedback
      setTimeout(() => {
        window.location.href = href;
      }, 150);
    });
  });

  // Handle skip button
  document.querySelector('.skip-personalization')?.addEventListener('click', () => {
    // Track skip event
    if (window.pdPixel) {
      window.pdPixel.track('persona_path_skipped', {
        source: 'decision_engine',
        page: window.location.pathname,
      });
    }

    // Store as "general" visitor
    storePersona('general');

    // Navigate to default destination (shop page or similar)
    window.location.href = '/shop/';
  });

  // Check for existing persona on page load (optional auto-redirect)
  // Uncomment if you want returning visitors to auto-redirect
  // const existingPersona = getStoredPersona();
  // if (existingPersona && existingPersona.id !== 'general') {
  //   const href = document.querySelector(`[data-persona-id="${existingPersona.id}"]`)?.dataset.personaHref;
  //   if (href) window.location.href = href;
  // }
</script>

<style>
  .persona-card:focus {
    outline: none;
    ring: 4px;
    ring-color: var(--color-accent);
    ring-opacity: 0.5;
  }

  .persona-card:active {
    transform: scale(0.98);
  }

  /* Animation for cards */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .persona-card {
    animation: fadeInUp 0.5s ease-out forwards;
  }

  .persona-card:nth-child(1) { animation-delay: 0.1s; }
  .persona-card:nth-child(2) { animation-delay: 0.2s; }
  .persona-card:nth-child(3) { animation-delay: 0.3s; }
</style>
