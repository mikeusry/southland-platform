---
/**
 * Outcome Survey Component
 *
 * CDP Week 1 - Post-purchase outcome collection
 * Captures real results from customers to build proof points and improve persona scoring.
 *
 * Triggered via Klaviyo email flows at 30/60/90 days post-purchase.
 * Data flows to BigQuery for CDP analysis.
 */

interface SurveyQuestion {
  id: string;
  type: 'rating' | 'select' | 'multiselect' | 'text' | 'number';
  question: string;
  description?: string;
  required?: boolean;
  options?: Array<{ value: string; label: string }>;
  min?: number;
  max?: number;
  placeholder?: string;
}

interface Props {
  surveyId: string;
  persona: 'backyard' | 'commercial' | 'lawn';
  title: string;
  description: string;
  questions: SurveyQuestion[];
  successMessage?: string;
  class?: string;
}

const {
  surveyId,
  persona,
  title,
  description,
  questions,
  successMessage = "Thank you! Your feedback helps us improve our products.",
  class: className = '',
} = Astro.props;

// API endpoint for survey submissions
const submitEndpoint = '/api/survey/submit';
---

<div class={`outcome-survey ${className}`} data-survey-id={surveyId} data-persona={persona}>
  <!-- Survey Form -->
  <form class="survey-form space-y-8" data-endpoint={submitEndpoint}>
    <!-- Hidden fields for tracking -->
    <input type="hidden" name="survey_id" value={surveyId} />
    <input type="hidden" name="persona" value={persona} />
    <input type="hidden" name="submitted_at" value="" />

    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold mb-3" style="color: var(--color-title);">
        {title}
      </h1>
      <p class="text-gray-600 max-w-xl mx-auto">
        {description}
      </p>
    </div>

    <!-- Questions -->
    <div class="space-y-6">
      {questions.map((q, index) => (
        <div class="survey-question bg-white rounded-xl border border-gray-200 p-6" data-question-id={q.id}>
          <label class="block mb-4">
            <span class="text-lg font-semibold text-gray-900">
              {index + 1}. {q.question}
              {q.required && <span class="text-red-500 ml-1">*</span>}
            </span>
            {q.description && (
              <span class="block text-sm text-gray-500 mt-1">{q.description}</span>
            )}
          </label>

          {/* Rating (1-5 or 1-10 scale) */}
          {q.type === 'rating' && (
            <div class="rating-group flex flex-wrap gap-2" role="radiogroup" aria-label={q.question}>
              {Array.from({ length: (q.max || 5) - (q.min || 1) + 1 }, (_, i) => (q.min || 1) + i).map((num) => (
                <label class="rating-option">
                  <input
                    type="radio"
                    name={q.id}
                    value={num}
                    required={q.required}
                    class="sr-only peer"
                  />
                  <span class="flex items-center justify-center w-12 h-12 rounded-lg border-2 border-gray-200 cursor-pointer transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-green-300 font-semibold">
                    {num}
                  </span>
                </label>
              ))}
            </div>
          )}

          {/* Select dropdown */}
          {q.type === 'select' && (
            <select
              name={q.id}
              required={q.required}
              class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            >
              <option value="">Select an option...</option>
              {q.options?.map((opt) => (
                <option value={opt.value}>{opt.label}</option>
              ))}
            </select>
          )}

          {/* Multi-select checkboxes */}
          {q.type === 'multiselect' && (
            <div class="space-y-2">
              {q.options?.map((opt) => (
                <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors">
                  <input
                    type="checkbox"
                    name={q.id}
                    value={opt.value}
                    class="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500"
                  />
                  <span class="text-gray-700">{opt.label}</span>
                </label>
              ))}
            </div>
          )}

          {/* Text input */}
          {q.type === 'text' && (
            <textarea
              name={q.id}
              required={q.required}
              placeholder={q.placeholder || 'Your answer...'}
              rows={3}
              class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
            />
          )}

          {/* Number input */}
          {q.type === 'number' && (
            <input
              type="number"
              name={q.id}
              required={q.required}
              placeholder={q.placeholder || 'Enter a number...'}
              min={q.min}
              max={q.max}
              class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            />
          )}
        </div>
      ))}
    </div>

    <!-- Submit Button -->
    <div class="text-center pt-4">
      <button
        type="submit"
        class="btn-primary px-8 py-4 text-lg"
      >
        Submit Feedback
      </button>
      <p class="text-sm text-gray-500 mt-4">
        Your responses are confidential and help us improve our products.
      </p>
    </div>
  </form>

  <!-- Success State (hidden by default) -->
  <div class="survey-success hidden text-center py-16">
    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
    </div>
    <h2 class="text-2xl font-bold mb-3" style="color: var(--color-title);">
      Thank You!
    </h2>
    <p class="text-gray-600 max-w-md mx-auto mb-8">
      {successMessage}
    </p>
    <a href="/" class="btn-secondary">
      Return to Homepage
    </a>
  </div>

  <!-- Error State (hidden by default) -->
  <div class="survey-error hidden text-center py-8">
    <div class="bg-red-50 border border-red-200 rounded-xl p-6 max-w-md mx-auto">
      <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-red-800 mb-2">Something went wrong</h3>
      <p class="text-red-600 text-sm mb-4">We couldn't submit your survey. Please try again.</p>
      <button class="retry-btn text-red-700 font-medium hover:underline">
        Try Again
      </button>
    </div>
  </div>
</div>

<script>
  // Outcome Survey Client Logic
  document.querySelectorAll('.outcome-survey').forEach((surveyContainer) => {
    const form = surveyContainer.querySelector('.survey-form') as HTMLFormElement;
    const successDiv = surveyContainer.querySelector('.survey-success');
    const errorDiv = surveyContainer.querySelector('.survey-error');
    const retryBtn = surveyContainer.querySelector('.retry-btn');

    if (!form) return;

    // Get URL parameters (order_id, email from Klaviyo links)
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('order_id') || urlParams.get('oid');
    const email = urlParams.get('email') || urlParams.get('e');
    const flowId = urlParams.get('flow_id') || urlParams.get('fid');

    // Add hidden fields for tracking
    if (orderId) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'order_id';
      input.value = orderId;
      form.appendChild(input);
    }
    if (email) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'email';
      input.value = decodeURIComponent(email);
      form.appendChild(input);
    }
    if (flowId) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'flow_id';
      input.value = flowId;
      form.appendChild(input);
    }

    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = submitBtn.textContent;

      // Set submission timestamp
      const timestampInput = form.querySelector('input[name="submitted_at"]') as HTMLInputElement;
      if (timestampInput) {
        timestampInput.value = new Date().toISOString();
      }

      // Collect form data
      const formData = new FormData(form);
      const data: Record<string, any> = {};

      // Handle multi-select fields (checkboxes with same name)
      const processedFields = new Set<string>();

      formData.forEach((value, key) => {
        if (processedFields.has(key)) return;

        const allValues = formData.getAll(key);
        if (allValues.length > 1) {
          data[key] = allValues;
        } else {
          data[key] = value;
        }
        processedFields.add(key);
      });

      // Add page context
      data.page_url = window.location.href;
      data.user_agent = navigator.userAgent;
      data.referrer = document.referrer;

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const endpoint = form.dataset.endpoint || '/api/survey/submit';
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          // Track success via point.dog pixel
          if (window.pdPixel) {
            window.pdPixel.track('outcome_survey_completed', {
              survey_id: data.survey_id,
              persona: data.persona,
              order_id: data.order_id || null,
            });
          }

          // Track in GTM dataLayer
          if (window.dataLayer) {
            window.dataLayer.push({
              event: 'outcome_survey_completed',
              survey_id: data.survey_id,
              persona: data.persona,
            });
          }

          // Show success state
          form.classList.add('hidden');
          successDiv?.classList.remove('hidden');
          errorDiv?.classList.add('hidden');
        } else {
          throw new Error('Submission failed');
        }
      } catch (error) {
        console.error('Survey submission error:', error);

        // Show error state
        errorDiv?.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    // Retry button handler
    retryBtn?.addEventListener('click', () => {
      errorDiv?.classList.add('hidden');
    });
  });
</script>

<style>
  .rating-option:focus-within span {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
</style>
