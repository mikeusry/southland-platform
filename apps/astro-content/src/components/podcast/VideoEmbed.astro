---
/**
 * Video embed component - supports Mux, YouTube, and direct video
 * Tracks play events via Southland pixel
 */

interface Props {
  muxPlaybackId?: string
  youtubeUrl?: string
  videoUrl?: string
  title: string
  episodeNumber: number
  episodeSlug: string
  poster?: string
  autoplay?: boolean
  class?: string
}

const {
  muxPlaybackId,
  youtubeUrl,
  videoUrl,
  title,
  episodeNumber,
  episodeSlug,
  poster,
  autoplay = false,
  class: className = '',
} = Astro.props

// Extract YouTube video ID
const youtubeId = youtubeUrl?.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/)?.[1]

// Determine embed source
const embedSource = muxPlaybackId ? 'mux' : youtubeId ? 'youtube' : videoUrl ? 'direct' : null

// Mux thumbnail URL
const muxThumbnail = muxPlaybackId
  ? `https://image.mux.com/${muxPlaybackId}/thumbnail.jpg`
  : undefined
---

<div
  class={`video-embed relative aspect-video bg-black rounded-xl overflow-hidden ${className}`}
  data-episode-slug={episodeSlug}
  data-episode-number={episodeNumber}
  data-embed-source={embedSource}
>
  {
    embedSource === 'mux' && muxPlaybackId && (
      <mux-player
        playback-id={muxPlaybackId}
        accent-color="#44883e"
        metadata-video-title={title}
        default-hidden-captions
        style="width:100%;height:100%;--media-object-fit:cover;"
      />
    )
  }

  {
    embedSource === 'youtube' && youtubeId && (
      <iframe
        src={`https://www.youtube-nocookie.com/embed/${youtubeId}?autoplay=${autoplay ? 1 : 0}&rel=0&modestbranding=1`}
        class="absolute inset-0 h-full w-full"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen
        title={title}
      />
    )
  }

  {
    embedSource === 'direct' && videoUrl && (
      <video
        class="video-player absolute inset-0 h-full w-full"
        poster={poster || muxThumbnail}
        controls
        preload="metadata"
      >
        <source src={videoUrl} type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    )
  }

  {
    !embedSource && (
      <div class="absolute inset-0 flex items-center justify-center bg-gray-900 text-white">
        <div class="text-center">
          <svg
            class="mx-auto mb-4 h-16 w-16 text-gray-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
            />
          </svg>
          <p class="text-gray-400">Video unavailable</p>
        </div>
      </div>
    )
  }
</div>

{embedSource === 'mux' && (
  <script>
    import '@mux/mux-player';
  </script>
)}

<script>
  // Video tracking
  document.querySelectorAll('.video-embed').forEach((container) => {
    const episodeSlug = (container as HTMLElement).dataset.episodeSlug
    const episodeNumber = parseInt((container as HTMLElement).dataset.episodeNumber || '0')
    const embedSource = (container as HTMLElement).dataset.embedSource

    // Track Mux player events
    const muxPlayer = container.querySelector('mux-player') as any
    if (muxPlayer) {
      let trackedMilestones = new Set<number>()

      muxPlayer.addEventListener('play', () => {
        if (window.pdPixel?.track) {
          window.pdPixel.track('podcast_play', {
            episode_slug: episodeSlug,
            episode_number: episodeNumber,
            source: 'mux',
          })
        }
      })

      muxPlayer.addEventListener('timeupdate', () => {
        const progress = (muxPlayer.currentTime / muxPlayer.duration) * 100
        const milestones = [25, 50, 75, 100]

        milestones.forEach((milestone: number) => {
          if (progress >= milestone && !trackedMilestones.has(milestone)) {
            trackedMilestones.add(milestone)
            if (window.pdPixel?.track) {
              window.pdPixel.track('podcast_progress', {
                episode_slug: episodeSlug,
                episode_number: episodeNumber,
                progress_percent: milestone,
                current_time: Math.floor(muxPlayer.currentTime),
              })
            }
          }
        })
      })

      muxPlayer.addEventListener('ended', () => {
        if (window.pdPixel?.track) {
          window.pdPixel.track('podcast_complete', {
            episode_slug: episodeSlug,
            episode_number: episodeNumber,
            duration_seconds: Math.floor(muxPlayer.duration),
          })
        }
      })
    }

    // Track direct video player
    const videoPlayer = container.querySelector('.video-player') as HTMLVideoElement
    if (videoPlayer) {
      let trackedMilestones = new Set<number>()

      videoPlayer.addEventListener('play', () => {
        if (window.pdPixel?.track) {
          window.pdPixel.track('podcast_play', {
            episode_slug: episodeSlug,
            episode_number: episodeNumber,
            source: embedSource,
          })
        }
      })

      videoPlayer.addEventListener('timeupdate', () => {
        const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100
        const milestones = [25, 50, 75, 100]

        milestones.forEach((milestone) => {
          if (progress >= milestone && !trackedMilestones.has(milestone)) {
            trackedMilestones.add(milestone)
            if (window.pdPixel?.track) {
              window.pdPixel.track('podcast_progress', {
                episode_slug: episodeSlug,
                episode_number: episodeNumber,
                progress_percent: milestone,
                current_time: Math.floor(videoPlayer.currentTime),
              })
            }
          }
        })
      })

      videoPlayer.addEventListener('ended', () => {
        if (window.pdPixel?.track) {
          window.pdPixel.track('podcast_complete', {
            episode_slug: episodeSlug,
            episode_number: episodeNumber,
            duration_seconds: Math.floor(videoPlayer.duration),
          })
        }
      })
    }

    // For YouTube embeds, track iframe load
    if (embedSource === 'youtube') {
      const iframe = container.querySelector('iframe')
      if (iframe) {
        iframe.addEventListener('load', () => {
          if (window.pdPixel?.track) {
            window.pdPixel.track('podcast_embed_loaded', {
              episode_slug: episodeSlug,
              episode_number: episodeNumber,
              source: embedSource,
            })
          }
        })
      }
    }
  })
</script>
