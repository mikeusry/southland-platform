---
/**
 * Share clip tool - set start/end timestamps and generate shareable URL
 */

interface Props {
  episodeSlug: string
  episodeNumber: number
  episodeTitle: string
  durationSeconds: number
  class?: string
}

const {
  episodeSlug,
  episodeNumber,
  episodeTitle,
  durationSeconds,
  class: className = '',
} = Astro.props

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://southlandorganics.com'
const episodeUrl = `${siteUrl}/podcast/${episodeSlug}/`

// Format time (seconds to MM:SS)
function formatTime(seconds: number): string {
  const mins = Math.floor(seconds / 60)
  const secs = Math.floor(seconds % 60)
  return `${mins}:${secs.toString().padStart(2, '0')}`
}
---

<div
  class={`share-clip-tool bg-white rounded-xl border border-gray-100 p-4 ${className}`}
  data-episode-slug={episodeSlug}
  data-episode-number={episodeNumber}
  data-episode-title={episodeTitle}
  data-episode-url={episodeUrl}
  data-duration={durationSeconds}
>
  <h3 class="mb-3 flex items-center gap-2 font-semibold text-gray-900">
    <svg class="h-5 w-5 text-southland-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z"
      ></path>
    </svg>
    Share a Clip
  </h3>

  <p class="mb-4 text-sm text-gray-600">
    Select a portion of this episode to share with friends or on social media.
  </p>

  {/* Time range selector */}
  <div class="mb-4 space-y-4">
    <div class="flex items-center gap-4">
      <div class="flex-1">
        <label class="mb-1 block text-xs font-medium text-gray-500">Start Time</label>
        <input
          type="text"
          class="start-time-input w-full rounded-lg border border-gray-200 px-3 py-2 text-center font-mono text-sm focus:border-southland-green focus:outline-none focus:ring-2 focus:ring-southland-green"
          placeholder="0:00"
          value="0:00"
        />
      </div>
      <div class="flex-1">
        <label class="mb-1 block text-xs font-medium text-gray-500">End Time</label>
        <input
          type="text"
          class="end-time-input w-full rounded-lg border border-gray-200 px-3 py-2 text-center font-mono text-sm focus:border-southland-green focus:outline-none focus:ring-2 focus:ring-southland-green"
          placeholder="0:30"
          value="0:30"
        />
      </div>
    </div>

    {/* Duration indicator */}
    <div class="clip-duration text-center text-sm text-gray-500">
      Clip duration: <span class="font-medium">0:30</span>
    </div>

    {/* Hint */}
    <p class="text-center text-xs text-gray-400">
      Enter times in MM:SS format (e.g., 5:30 for 5 minutes 30 seconds)
    </p>
  </div>

  {/* Generated URL */}
  <div class="mb-4">
    <label class="mb-1 block text-xs font-medium text-gray-500">Shareable Link</label>
    <div class="flex gap-2">
      <input
        type="text"
        class="share-url-input flex-1 rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm"
        readonly
        value={`${episodeUrl}?t=0`}
      />
      <button
        type="button"
        class="copy-url-btn rounded-lg bg-southland-green px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-southland-green-dark"
      >
        Copy
      </button>
    </div>
  </div>

  {/* Share buttons */}
  <div class="flex flex-wrap gap-2">
    <button
      type="button"
      class="share-twitter-btn inline-flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200"
    >
      <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"
        ></path>
      </svg>
      Twitter
    </button>
    <button
      type="button"
      class="share-linkedin-btn inline-flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200"
    >
      <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
        ></path>
      </svg>
      LinkedIn
    </button>
    <button
      type="button"
      class="share-facebook-btn inline-flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200"
    >
      <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"
        ></path>
      </svg>
      Facebook
    </button>
  </div>

  {/* Success toast */}
  <div
    class="copy-success-toast fixed bottom-4 right-4 z-50 hidden rounded-lg bg-southland-green px-4 py-2 text-sm text-white shadow-lg"
  >
    Link copied to clipboard!
  </div>
</div>

<script>
  document.querySelectorAll('.share-clip-tool').forEach((container) => {
    const episodeSlug = (container as HTMLElement).dataset.episodeSlug
    const episodeNumber = parseInt((container as HTMLElement).dataset.episodeNumber || '0')
    const episodeTitle = (container as HTMLElement).dataset.episodeTitle
    const episodeUrl = (container as HTMLElement).dataset.episodeUrl
    const duration = parseInt((container as HTMLElement).dataset.duration || '0')

    const startInput = container.querySelector('.start-time-input') as HTMLInputElement
    const endInput = container.querySelector('.end-time-input') as HTMLInputElement
    const clipDuration = container.querySelector('.clip-duration span')
    const shareUrlInput = container.querySelector('.share-url-input') as HTMLInputElement
    const copyUrlBtn = container.querySelector('.copy-url-btn')
    const successToast = container.querySelector('.copy-success-toast')

    let startTime = 0
    let endTime = 30

    // Parse time string (MM:SS) to seconds
    function parseTime(timeStr: string): number {
      const parts = timeStr.split(':').map(Number)
      if (parts.length === 2) {
        return parts[0] * 60 + parts[1]
      } else if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2]
      }
      return 0
    }

    // Format seconds to MM:SS
    function formatTime(seconds: number): string {
      const mins = Math.floor(seconds / 60)
      const secs = Math.floor(seconds % 60)
      return `${mins}:${secs.toString().padStart(2, '0')}`
    }

    // Update URL and duration display
    function updateClip() {
      const clipDurationSecs = Math.max(0, endTime - startTime)
      if (clipDuration) clipDuration.textContent = formatTime(clipDurationSecs)

      // Update URL with timestamp
      shareUrlInput.value = `${episodeUrl}?t=${startTime}${endTime < duration ? `&end=${endTime}` : ''}`
    }

    // Input handlers
    startInput.addEventListener('change', () => {
      startTime = parseTime(startInput.value)
      startInput.value = formatTime(startTime)
      if (startTime >= endTime) {
        endTime = Math.min(startTime + 30, duration)
        endInput.value = formatTime(endTime)
      }
      updateClip()
    })

    endInput.addEventListener('change', () => {
      endTime = parseTime(endInput.value)
      endInput.value = formatTime(endTime)
      if (endTime <= startTime) {
        startTime = Math.max(endTime - 30, 0)
        startInput.value = formatTime(startTime)
      }
      updateClip()
    })

    // Copy URL
    copyUrlBtn?.addEventListener('click', () => {
      navigator.clipboard.writeText(shareUrlInput.value).then(() => {
        successToast?.classList.remove('hidden')
        setTimeout(() => successToast?.classList.add('hidden'), 2000)

        // Track share clip
        if (window.pdPixel?.track) {
          window.pdPixel.track('podcast_share_clip', {
            episode_slug: episodeSlug,
            episode_number: episodeNumber,
            start_time: startTime,
            end_time: endTime,
            method: 'copy',
          })
        }
      })
    })

    // Social share buttons
    const shareText = `Check out this clip from "${episodeTitle}" - Ag & Culture Podcast`

    container.querySelector('.share-twitter-btn')?.addEventListener('click', () => {
      const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrlInput.value)}`
      window.open(url, '_blank', 'width=600,height=400')
      trackShare('twitter')
    })

    container.querySelector('.share-linkedin-btn')?.addEventListener('click', () => {
      const url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrlInput.value)}`
      window.open(url, '_blank', 'width=600,height=400')
      trackShare('linkedin')
    })

    container.querySelector('.share-facebook-btn')?.addEventListener('click', () => {
      const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrlInput.value)}`
      window.open(url, '_blank', 'width=600,height=400')
      trackShare('facebook')
    })

    function trackShare(platform: string) {
      if (window.pdPixel?.track) {
        window.pdPixel.track('podcast_share_clip', {
          episode_slug: episodeSlug,
          episode_number: episodeNumber,
          start_time: startTime,
          end_time: endTime,
          method: platform,
        })
      }
    }

    // Initialize
    updateClip()
  })
</script>
