---
/**
 * Email capture component - integrates with Klaviyo
 * Used across podcast and content pages
 *
 * Podcast subscribers get these custom properties:
 * - podcast_subscriber: true
 * - podcast_subscribed_at: ISO timestamp
 * - podcast_signup_episode: episode slug (if on episode page)
 * - podcast_signup_source: "episode_page" | "hub" | "footer"
 */

interface Props {
  headline?: string
  description?: string
  listId?: string
  source?: 'episode_page' | 'hub' | 'footer' | 'blog' | 'website'
  episodeSlug?: string
  buttonText?: string
  variant?: 'inline' | 'card' | 'banner'
  class?: string
}

const {
  headline = 'Subscribe to Ag & Culture',
  description = 'Get notified when new episodes drop, plus exclusive content and tips.',
  listId = import.meta.env.PUBLIC_KLAVIYO_LIST_ID || 'QQxdLS',
  source = 'podcast',
  episodeSlug = '',
  buttonText = 'Subscribe',
  variant = 'card',
  class: className = '',
} = Astro.props

const klaviyoCompanyId = import.meta.env.PUBLIC_KLAVIYO_COMPANY_ID || 'p8XW7D'

const variantClasses = {
  inline: '',
  card: 'bg-white rounded-xl shadow-sm border border-gray-100 p-6',
  banner: 'bg-southland-green text-white p-6 rounded-xl shadow-lg shadow-black/10',
}

const inputClasses =
  variant === 'banner'
    ? 'w-full px-4 py-3 rounded-md bg-white/15 border border-white/25 text-white placeholder-white/80 focus:outline-none focus:ring-2 focus:ring-white/60 focus:border-white/40 transition-all duration-200'
    : 'w-full px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-southland-green focus:border-transparent'

const buttonClasses =
  variant === 'banner'
    ? 'w-full sm:w-auto px-8 py-3 bg-white text-southland-green-dark font-bold rounded-md shadow-md hover:bg-gray-50 hover:shadow-lg active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-white/60 focus:ring-offset-2 focus:ring-offset-southland-green transition-all duration-200'
    : 'w-full sm:w-auto btn-primary'
---

<div
  class={`email-capture ${variantClasses[variant]} ${className}`}
  data-source={source}
  data-episode-slug={episodeSlug}
>
  {(headline || description) && (
    <div class="mb-4">
      {headline && (
        <h3 class={`font-bold text-lg ${variant === 'banner' ? '' : 'text-gray-900'}`}>
          {headline}
        </h3>
      )}
      {description && (
        <p class={`text-sm mt-1 ${variant === 'banner' ? 'text-white/80' : 'text-gray-600'}`}>
          {description}
        </p>
      )}
    </div>
  )}

  <form
    class="klaviyo-form flex flex-col gap-3 sm:flex-row"
    data-list-id={listId}
    data-klaviyo-company-id={klaviyoCompanyId}
  >
    <div class="flex-1">
      <label for="email-capture-input" class="sr-only">Email address</label>
      <input
        type="email"
        id="email-capture-input"
        name="email"
        placeholder="Enter your email"
        required
        class={inputClasses}
      />
    </div>
    <button type="submit" class={buttonClasses}>
      {buttonText}
    </button>
  </form>

  <!-- Success message (hidden by default) -->
  <div class="success-message hidden">
    <div
      class={`flex items-center gap-3 p-4 rounded-lg ${variant === 'banner' ? 'bg-white/10 text-white' : 'bg-green-50 text-southland-green'}`}
    >
      <svg class="h-6 w-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div>
        <p class="font-semibold">You're in!</p>
        <p class={`text-sm ${variant === 'banner' ? 'text-white/80' : 'text-gray-600'}`}>
          We'll notify you when new episodes drop.
        </p>
      </div>
    </div>
  </div>

  <!-- Error message (hidden by default) -->
  <div class="error-message mt-4 hidden">
    <div class="flex items-center gap-2 text-red-500">
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span class="font-medium">Something went wrong. Please try again.</span>
    </div>
  </div>
</div>

<script>
  // Klaviyo form submission handler with podcast-specific properties
  document.querySelectorAll('.klaviyo-form').forEach((form) => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      const formEl = e.target as HTMLFormElement
      const emailInput = formEl.querySelector('input[type="email"]') as HTMLInputElement
      const listId = formEl.dataset.listId
      const companyId = formEl.dataset.klaviyoCompanyId
      const container = formEl.closest('.email-capture')
      const source = container?.getAttribute('data-source') || 'website'
      const episodeSlug = container?.getAttribute('data-episode-slug') || ''

      const email = emailInput?.value

      if (!email || !listId || !companyId) {
        console.error('Missing required fields for Klaviyo submission')
        return
      }

      const submitButton = formEl.querySelector('button[type="submit"]') as HTMLButtonElement
      const successMessage = formEl.parentElement?.querySelector('.success-message')
      const errorMessage = formEl.parentElement?.querySelector('.error-message')

      // Show loading state
      submitButton.disabled = true
      submitButton.textContent = 'Subscribing...'

      // Build podcast-specific properties
      const isPodcastSource =
        ['episode_page', 'hub', 'footer'].includes(source) ||
        window.location.pathname.includes('/podcast')
      const properties: Record<string, any> = {
        source: source,
        signup_page: window.location.pathname,
      }

      // Add podcast subscriber properties
      if (isPodcastSource) {
        properties.podcast_subscriber = true
        properties.podcast_subscribed_at = new Date().toISOString()
        properties.podcast_signup_source = source
        if (episodeSlug) {
          properties.podcast_signup_episode = episodeSlug
        }
      }

      try {
        // Klaviyo Client Subscribe API (2024 format)
        const response = await fetch(
          `https://a.klaviyo.com/client/subscriptions/?company_id=${companyId}`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              revision: '2024-02-15',
            },
            body: JSON.stringify({
              data: {
                type: 'subscription',
                attributes: {
                  custom_source: 'Podcast Signup',
                  profile: {
                    data: {
                      type: 'profile',
                      attributes: {
                        email: email,
                        properties: properties,
                      },
                    },
                  },
                },
                relationships: {
                  list: {
                    data: {
                      type: 'list',
                      id: listId,
                    },
                  },
                },
              },
            }),
          }
        )

        // Klaviyo returns 202 with empty body on success
        if (response.status === 200 || response.status === 202) {
          // Hide form, show success
          formEl.classList.add('hidden')
          if (successMessage) {
            successMessage.classList.remove('hidden')
          }

          // Also hide the headline/description
          const header = container?.querySelector('.mb-4')
          if (header) {
            header.classList.add('hidden')
          }

          // Track conversion via point.dog pixel
          if (window.pdPixel) {
            window.pdPixel.track('email_signup', {
              source: source,
              list_id: listId,
              podcast_subscriber: isPodcastSource,
              episode_slug: episodeSlug || null,
            })
          }
        } else {
          throw new Error(`Subscription failed: ${response.status}`)
        }
      } catch (error) {
        console.error('Email signup error:', error)
        errorMessage?.classList.remove('hidden')
        submitButton.disabled = false
        submitButton.textContent = 'Subscribe'
      }
    })
  })
</script>
